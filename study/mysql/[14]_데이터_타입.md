# 지옥 스터디 - 14 데이터 타입
- 칼럼의 데이터 타입을 선정하는 일은 물리 모델링에서 중요한 작업.
- 데이터 타입과 길이 선정시 다음 사항을 주의해야 한다.
  - 저장되는 값의 **성격에 맞는 최적의 타입** 선정
  - 가변 길이 칼럼의 경우 최적의 길이 설정
  - 조인 조건으로 사용되는 경우 동일한 데이터 타입으로 선정
- 일반적으로 저장되는 값의 특성을 고려하지 않고 가능한 최대 길이로 선택하는 것이 일반적인데, 무분별하게 크게 선정되면 디스크 는 물론 메모리/CPU 자원도 함께 낭비된다.
  - 그로 인해 SQL 성능 저하는 당연한 결과.
- 데이터 타입의 길이는 너무 넉넉해도 안되고 부족해도 문제가 된다.
- 실제 저장되는 값의 성격을 정확히 분석하고 최적의 타입과 길이를 선정하는것이 중요.

## 문자열 (CHAR 와 VARCHAR)
- 문자열 컬럼을 사용하는 경우 CHAR 와 VARCHAR 중 선택해야 하낟.
- 이 둘은 장단점을 갖고 있으며 저장 공간과 비교 방식 관점에서 이들을 살펴본다.

### 저장 공간
- CHAR 와 VARCHAR 의 공통점은 문자열 저장이 가능한 데이터 타입이다.
- 가장 큰 차이는 **고정길이** 냐, **가변길이** 냐 이다.
- 고정길이는 실제 칼럼값의 길이에 따라 저장 공간의 크기가 변하지 않음.
  - 저장 공간의 크기가 고정적 이다.
- 가변길이는 최대 저장 가능한 값의 길이는 제한되어 있지만, 그 보다 작은 값이 저장되면 그 만큼 저장공간이 줄어듦
  - 하지만 저장된 값의 크기를 가지는 메타 정보를 가지고 있어야하기 때문에 1 ~ 2 바이트 정도 저장 공간이 추가로 더 필요하다.
- VARCHAR 의 경우 문자열 길이 관리를 위한 1 ~ 2 바이트 공간을 추가로 사용한다.
  - 255 바이트 이하면 1바이트만  사용하고, 256 바이트 이상이라면 2바이트를 사용한다.
  - VARCHAR 타입의 최대 길이는 2바이트로 범위를 넘어선다면 사용할 수 없다.
  - 즉 VARCHAR 타입에 저장가능한 최대 길이는 65,536 바이트

`참고`
- MySQL 에서 하나의 레코드는 TEXT/BLOB 타입을 제외한 전체 크기가 64KB 를 초과할 수 없다.
- 만약 다른컬럼에서 40KB 를 사용하고 있다면 VARCHAR 는 24KB 가 최대값.
- 24KB 를 넘도록 생성할경우 에러가 발생하거나 자동으로 TEXT 타입으로 대체된다.
- 때문에 컬럼을 새로 추가한다면 VARCHAR 가 TEXT 타입으로 자동변환되었는지 확인하는 것이 좋다.

> 문자열 값의 길이가 항상 일정하다면 CHAR 를, 가변적이라면 VARCHAR 를 사용하는 것이 일반적이지만 문자열 길이가 정적이냐 가변적이냐 여부로만 타입을 결정하는 것은 좋지 않다.

`타입 결졍시 고려할 두 가지`
- 저장되는 문자열의 길이가 대개 비슷한가 ?
- 칼럼의 값이 자주 변경되는가 ?

> 값의 길이도 중요하지만, 해당 칼럼의 값이 얼마나 자주 변경되느냐 가 기준이 되어야 한다.

CHAR(10) 타입 사용중이라면 값 변경시 10바이트가 준비되어 있으므로 변경되는 값을 업데이트만 하면 된다.

하지만 VARCHAR(10) 타입을 사용중이라면 기존에 4바이트 데이터가 저장되었다가 길이가 더 큰 값으로 변경되는 경우 **레코드 자체를 다른 공간으로 옮겨 저장하는 작업이 필요** 하다.

주민등록번호 처럼 항상 값의 길이가 고정이라면 CHAR 를 사용 해야한다. 값이 2 ~ 3 바이트 차이나더라도 자주 변경되는 부서 번호나 게시물 상태 값 등은 CHAR 를 사용하는 것이 좋다.
- 레코드 이동이나 분리작업이 2 ~ 3 바이트 공간 보다 비용이 더 크기 때문임.

CHAR 나 VARCHAR 뒤 크기는 해당 칼럼의 바이트 크기가 아닌 **문자의 수** 를 의미한다.
- CHAR(10) 이라면 10글자를 저장할 수 있는 공간을 의미.

`참고`
- MySQL 5.5 이전버전 까지 utf8 문자셋을 사용했지만 이는 한글자당 최대 3바이트 까지만 지원했다.
  - SMP, SIP 그 이후 플레인 문자는 저장 불가능
- 이르 해결하기 위해 utf8mb4 문자셋이 도입됨 (최대 4바이트)
- 이는 유니코드에서 지원하는 대부분의 문자를 지원함.

### 저장 공간과 스키마 변경 (Online DDL)
- VARCHAR 데이터 타입의 길이를 늘리는 작업은 경우에 따라 읽기잠금을 걸고 레코드 복사작업이 필요할 수도 있다.

```sql
CREATE TABLE test (
    id INT PRIMARY KEY,
    value VARCHAR(60)
) DEFAULT CHARSET=utf8mb4;

ALTER TABLE test MODIFY value VARCHAR(63), ALGORITHM=INPLACE, LOCK=NONE;
// 성공

ALTER TABLE test MODIFY value VARCHAR(64), ALGORITHM=INPLACE, LOCK=NONE;
// 에러 발생
```
- 기존에 길이가 60 으로 정의된 타입을 63 으로 늘릴 경우 문제가 없지만 64로 늘릴 경우 에러가 발생한다.
- 이는 VARCHAR 타입이 가지는 길이 저장 공간의 크기 때문.
- VARCHAR(60) 은 1바이트면 되지만, VARCHAR(64) 의 경우 2바이트로 변경되어야 한다.
- 문자열 길이 저장 공간의 크기가 바뀌면 MySQL 서버는 스키마를 변경하는 동안 읽기 잠금을 걸고 레코드를 복사하는 방식을 사용한다.

> 위와 같은 이유로 문자열 타입 설계시 VARCHAR 의 길이가 크게 변경될 것으로 예상된다면 길이 저장 공간의 크기가 바뀌지 않도록 조금 크게 설계하는 것이 좋다.

### 문자 집합 (CharacterSet)
- MySQL 에서 문자 집합은 문자열을 저장하는 CHAR, VARCHAR, TEXT 컬럼에만 설정이 가능하다.
- 최종적으로 칼럼 단위로 문자 집합을 관리하지만, 편의를 위해 MySQL 서버와 DB, 테이블 단위 설정 기능을 제공한다.
- 사용 가능한 문자 집합은 `SHOW CHARACTER SET` 명령으로 확인 가능하다.
- `latin` 계열 문자는 알파벳/숫자 특수문자로 구성된 문자열만 저장해도 될 때 저장 공간 절약이 가능한 문자 집합이다.
- `euckr` 은 한국어 전용이며 모든 글자는 1 ~ 2 바이트를 사용한다.
- `utf8mb4` 는 다국어 문자를 포함할 수 있는 컬럼에 사용하기 적합하다.
  - 일반적으로 1 ~ 4 바이트까지 사용함.
- `utf8` 은 한 글자 저장시 1 ~ 3 바이트 까지 사용한다.

`MySQL 문자 집합 설정 시스템 변수`
- `character_set_system`
  - MySQL 서버가 식별자 저장시 사용하는 문자 집합
  - 기본값 utf8
- `character_set_server`
  - MySQL 서버의 기본 문자 집합
  - DB 나 테이블 혹은 칼럼에 설정된게 없을 경우 이 값이 사용됨
  - 기본 값 utf8mb4
- `character_set_database`
  - MySQL DB 의 기본 문자 집합
  - DB 생성시 설정된게 없을 경우 이 값이 사용됨
  - 기본 값 utf8mb4
- `character_set_filesystem`
  - `LOAD DATA INFILE ...` 혹은 `SELECT ... INTO OUTFILE` 실행시 인자로 지정되는 파일 이름 해석시 사용되는 문자 집합
  - 파일 내용이 아닌 파일 이름을 찾을 때 사용하는 것 임을 유의.
  - 기본 값 binary
- `character_set_client`
  - MySQL 클라이언트가 보낸 문장은 `character_set_client` 에 설정된 문자 집합으로 인코딩해 MySQL 서버로 전송한다.
  - 기본 값 utf8mb4
- `character_set_connection`
  - MySQL 서버가 클라이언트로부터 받은 SQL 문장을 처리하기 위해 `character_set_connection` 의 문자 집합으로 변환한다.
  - 기본 값 utf8mb4
- `character_set_results`
  - MySQL 서버가 쿼리의 처리 결과를 클라이언트로 보낼때 사용하는 문자 집합
  - 기본 값 utf8mb4

#### 클아이언트로 부터 쿼리 요청시 문자 집합 변환
- MySQL 서버는 받은 문자열 데이터를 `character_set_connection` 에 정의된 문자 집합으로 변환한다.
- SQL 문장에서 별도로 문자 집합을 설정하는 지정자를 **인트로듀서** 라고 한다.

```sql
SELECT emp_no, first_name FROM employees WHERE first_name = _latin1'Matt';
```
- 일반적으로 인트로듀서는 문자열 리터럴 앞에 언더스코어와 문자 집합의 이름을 붙여 표현한다.

#### 처리 결과를 클라이언트로 전송할 때의 문자 집합 변환
- MySQL 서버는 쿼리의 결과를 `character_set_results` 변수에 설정된 문자 집합으로 변환해 클라이언트로 전송한다.
- 결과 셋에 포함된 칼럼값이나 메타데이터도 모두 인코딩되어 전송됨
- 변환전 문자 집합과 변환할 문자 집합이 일치한다면 문자집합 변환 작업은 모두 생략된다.