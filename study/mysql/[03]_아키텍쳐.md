# 지옥 스터디 - 03 아키텍쳐
- MySQL 서버는 머리 역할을 하는 **MySQL 엔진** 과, 손발 을 담당하는 **스토리지 엔진** 으로 구분할 수 있다.
- 스토리지 엔진은 핸들러 API 를 만족하면 누구든 구현해 추가한 뒤 사용이 가능하다.

## MySQL 엔진 아키텍쳐
- 기본적인 MySQL 엔진 구조
- 사용자 입장에선 거의 차이가 없지만 독특한 구조 덕에 다른 DBMS 에서는 누릴 수 없는 혜택을 누리기도 한다.

![MySQL Architecture](./images/mysql_architecture.png)

- 대부분의 프로그래밍 언어로부터 접근 방법을 제공
- MySQL 엔진과 스토리지 엔진 두 가지로 구분 가능

### MySQL 엔진
- MySQL 엔진은 SQL 문장 분석, 최적화 등 DBMS 의 **두뇌** 에 해당하는 처리를 수행
- 구성요소는 다음과 같다.
  - 클라이언트 접속 및 쿼리 요청을 수행하는 **커넥션 핸들러** 
  - **SQL 파서** 및 **전 처리기**
  - 쿼리 최적화를 위한 **옵티마이저** 로 구성됨
- ANSI 표준 문법 지원

### 스토리지 엔진
- 데이터를 디스크에 저장 혹은 데이터를 읽어오는 역할을 담당
- MySQL 엔진은 하나이지만 스토리지 엔진은 **여러 개를 동시에 사용 가능**
- 특정 테이블이 사용할 스토리지 엔진을 지정하면, 해당 테이블의 읽기/쓰기 작업은 해당 스토리지 엔진이 처리하게 된다
- 각 스토리지 엔진들은 성능 향상을 위해 키 캐시나 InnoDB 버퍼 풀 과 같은 기능을 내장하고 있다

```sql
CREATE TABLE test_table(
    fd1 INT,
    fd2 INT
) ENGINE=INNODB;
```

### 핸들러 API
- MySQL 엔진 쿼리 실행기에서 **데이터를 쓰거나 읽어야 할 때** 각 스토리지 엔진에 쓰기/읽기 요청을 한다
- 이런 요청을 **핸들러 (Handler)** 요청이라 하며 이때 사용하는 API 를 핸들러 API 라고 한다
- 핸들러 API 를 통해 얼마나 많은 데이터 작업이 있었는지 확인하기 위해 `SHOW GLOBAL STATUS LIKE 'Handler%';` 로 확인 가능하다

```sql
SHOW GLOBAL STATUS LIKE 'Handler%';

+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| Handler_commit             | 1041  |
| Handler_delete             | 84    |
| Handler_discover           | 0     |
| Handler_external_lock      | 12183 |
| Handler_mrr_init           | 0     |
| Handler_prepare            | 66    |
| Handler_read_first         | 223   |
| Handler_read_key           | 7890  |
| Handler_read_last          | 0     |
| Handler_read_next          | 10883 |
| Handler_read_prev          | 0     |
| Handler_read_rnd           | 2645  |
| Handler_read_rnd_next      | 14917 |
| Handler_rollback           | 5     |
| Handler_savepoint          | 0     |
| Handler_savepoint_rollback | 0     |
| Handler_update             | 412   |
| Handler_write              | 4706  |
+----------------------------+-------+
```

### MySQL 스레드 구조

![MySQL Thread](./images/mysql_thread.png)

- MySQL 은 **스레드** 기반 으로 동작
- 포그라운드 (Foreground) 와 백그라운드 (Background) 스레드로 구분한다
- 실행중인 스레드 목록은 `performance_schema.threads` 테이블로 확인 가능

```sql
SELECT thread_id,
       name,
       type,
       processlist_user,
       processlist_host
FROM performance_schema.threads
ORDER BY type, thread_id;

+-----------+---------------------------------------------+------------+------------------+------------------+
| thread_id | name                                        | type       | processlist_user | processlist_host |
+-----------+---------------------------------------------+------------+------------------+------------------+
|         1 | thread/sql/main                             | BACKGROUND | NULL             | NULL             |
|         3 | thread/innodb/io_ibuf_thread                | BACKGROUND | NULL             | NULL             |
|         4 | thread/innodb/io_log_thread                 | BACKGROUND | NULL             | NULL             |
|         5 | thread/innodb/io_read_thread                | BACKGROUND | NULL             | NULL             |
|         6 | thread/innodb/io_read_thread                | BACKGROUND | NULL             | NULL             |
|         7 | thread/innodb/io_read_thread                | BACKGROUND | NULL             | NULL             |
|         8 | thread/innodb/io_read_thread                | BACKGROUND | NULL             | NULL             |
|         9 | thread/innodb/io_write_thread               | BACKGROUND | NULL             | NULL             |
|        10 | thread/innodb/io_write_thread               | BACKGROUND | NULL             | NULL             |
|        11 | thread/innodb/io_write_thread               | BACKGROUND | NULL             | NULL             |
|        12 | thread/innodb/io_write_thread               | BACKGROUND | NULL             | NULL             |
|        13 | thread/innodb/page_flush_coordinator_thread | BACKGROUND | NULL             | NULL             |
|        14 | thread/innodb/log_checkpointer_thread       | BACKGROUND | NULL             | NULL             |
|        15 | thread/innodb/log_flush_notifier_thread     | BACKGROUND | NULL             | NULL             |
|        16 | thread/innodb/log_flusher_thread            | BACKGROUND | NULL             | NULL             |
|        17 | thread/innodb/log_write_notifier_thread     | BACKGROUND | NULL             | NULL             |
|        18 | thread/innodb/log_writer_thread             | BACKGROUND | NULL             | NULL             |
|        19 | thread/innodb/srv_lock_timeout_thread       | BACKGROUND | NULL             | NULL             |
|        20 | thread/innodb/srv_error_monitor_thread      | BACKGROUND | NULL             | NULL             |
|        21 | thread/innodb/srv_monitor_thread            | BACKGROUND | NULL             | NULL             |
|        22 | thread/innodb/buf_resize_thread             | BACKGROUND | NULL             | NULL             |
|        23 | thread/innodb/srv_master_thread             | BACKGROUND | NULL             | NULL             |
|        24 | thread/innodb/dict_stats_thread             | BACKGROUND | NULL             | NULL             |
|        25 | thread/innodb/fts_optimize_thread           | BACKGROUND | NULL             | NULL             |
|        26 | thread/mysqlx/worker                        | BACKGROUND | NULL             | NULL             |
|        27 | thread/mysqlx/worker                        | BACKGROUND | NULL             | NULL             |
|        28 | thread/mysqlx/acceptor_network              | BACKGROUND | NULL             | NULL             |
|        32 | thread/innodb/buf_dump_thread               | BACKGROUND | NULL             | NULL             |
|        33 | thread/innodb/clone_gtid_thread             | BACKGROUND | NULL             | NULL             |
|        34 | thread/innodb/srv_purge_thread              | BACKGROUND | NULL             | NULL             |
|        35 | thread/innodb/srv_worker_thread             | BACKGROUND | NULL             | NULL             |
|        36 | thread/innodb/srv_worker_thread             | BACKGROUND | NULL             | NULL             |
|        37 | thread/innodb/srv_purge_thread              | BACKGROUND | NULL             | NULL             |
|        38 | thread/innodb/srv_worker_thread             | BACKGROUND | NULL             | NULL             |
|        39 | thread/innodb/srv_worker_thread             | BACKGROUND | NULL             | NULL             |
|        40 | thread/innodb/srv_worker_thread             | BACKGROUND | NULL             | NULL             |
|        41 | thread/innodb/srv_worker_thread             | BACKGROUND | NULL             | NULL             |
|        43 | thread/sql/signal_handler                   | BACKGROUND | NULL             | NULL             |
|        44 | thread/mysqlx/acceptor_network              | BACKGROUND | NULL             | NULL             |
|        42 | thread/sql/event_scheduler                  | FOREGROUND | event_scheduler  | localhost        |
|        46 | thread/sql/compress_gtid_table              | FOREGROUND | NULL             | NULL             |
|       110 | thread/sql/one_connection                   | FOREGROUND | root             | 172.17.0.1       |
|       112 | thread/sql/one_connection                   | FOREGROUND | root             | localhost        |
+-----------+---------------------------------------------+------------+------------------+------------------+
```
- `thread/sql/one_connection` 스레드만 실제 사용자 요청을 처리하는 스레드이다

> 지금 살펴본 스레드 모델은 MySQL 서버의 전통적인 스레드 모델 (커뮤니티 에디션에서 사용) <br/>
> 엔터프라이즈 에서는 스레드풀 모델을 사용할 수 있다. <br/>
> 스레드 풀 모델은 **포그라운드와 커넥션** 과의 관계가 차이가 난다.
> 전통 스레드 모델은 커넥션 별로 하나씩 생성되지만 스레드 풀은 **하나의 스레드가 여러 커넥션의 요청을 담당** 한다

### 포그라운드 스레드 (클라이언트 스레드)
- 포그라운드 스레드는 최소한 MySQL 에 **접속한 클라이언트 수 만큼 존재**
- 주로 클라이언트가 요청한 쿼리 문장을 처리한다
- 작업을 마치고 커넥션을 종료하면 해당 스레드는 **스레드 캐시 (Thread Cache)** 로 되돌아간다
- 스레드 캐시에 일정 개수의 대기 스레드가 있다면, 스레드를 소멸시켜 **일정 개수의 스레드를 유지** 한다
  - `thread_cache_size` 시스템 변수로 조절 가능
- 포그라운드 스레드는 데이터를 데이터 버퍼/캐시로부터 가져오거나 디스크/인덱스 파일로 부터 데이를 읽어와 작업을 수행한다
  - MyISAM 은 데이터 쓰기까지 포그라운드 스레드가 수행
  - InnoDB 는 데이터 버퍼/캐시 까지만 포그라운드가 처리 쓰기 작업은 백그라운드가 수행

### 백그라운드 스레드
- InnoDB 기준 다음 작업들이 백그라운드 스레드에 의해 처리된다
  - 인서트 버퍼 (Insert Buffer)를 병합
  - 로그를 디스크에 기록
  - InnoDB 버퍼 풀의 데이터를 디스크에 기록
  - 데이터를 버퍼로 읽음
  - 잠금/데드락 모니터링
- 이중 중요한 것은 **로그 와 버퍼의 데이터를 디스크에 기록하는 작업**
  - 5.5 버전 부터는 쓰기/읽기 스레드를 개 이상 지정할 수 있다
  - `innodb_write_io_threads` , `innodb_read_io_threads` 시스템 변수로 지정
- 읽기 작업은 주로 포그라운드가 처리하기 때문에 많이 설정할 필요는 없다
- 쓰기 작업은 작업량이 상당하기 때문에 내장 디스크 사용시 2 ~ 4, DAS 나 SAN 스토리지라면 최적으로 사용할 만큼 충분히 설정할것

> 쓰기 작업은 지연 처리가 가능하지만, 읽기 작업은 절대 지연될 수 없다

- 대부분 쓰기 작업을 버퍼링해서 처리하는 기능이 내장되어 있다
- InnoDB 는 버퍼링 기능을 제공하지만 **MyISAM 에서 일반적인 쿼리는 쓰기 버퍼링 기능을 사용할 수 없음**

### 메모리 할당 및 구조

![MySQL Memory](./images/mysql_memory.png)

- MySQL 메모리 영역은 **글로벌 메모리** 와 **로컬 메모리** 로 구분
- 글로벌 메모리는, MySQL 서버 시작시 **운영 체제로 부터 할당** 됨
  - 운영체제 종류에 따라 할당하는 방식이 다르기 때문에 정확한 메모리양 측정이 쉽지 않음
  - 단순하게 MySQL 시스템 변수 만큼 할당받는다고 생각하는게 좋다

> 글로벌 메모리와 로컬 메모리는 **스레드 공유 여부** 에 따라 구분된다

### 글로벌 메모리 영역
- 클라이언트 스레두 수와 관계없이 하나의 메모리 공간만 할당된다
  - 필요시 2개 이상의 공간을 할당받을 수도 있으나, 클라이언드 스레드 수와 무관
  - 모든 스레드가 공유하는 영역
- 대표적인 글로벌 메모리 영역은 다음과 같다
  - 테이블 캐시
  - InnoDB 버퍼 풀
  - InnoDB 어댑티브 해시 인덱스
  - InnoDB 리두 로그 버퍼

### 로컬 메모리 영역
- **세션 메모리 영역** 이라고 표현
  - 클라이언트와 커넥션을 세션이라고 하기에 세션 메모리 영역이라고도 함
- 클라이언트 스레드가 쿼리 처리를 위해 사용
- 클라이언트로 부터 요청을 처리하기 위한 영역이기에 클라이언트 메모리 영역이라고도 함
- **스레드 별로 독립적 할당** 절대 공유되선 안됨
- 각 쿼리 용도별로 필요시에만 할당된다
  - 필요하지 않은경우 할당조차 되지 않을 수 있다
  - 소트 버퍼나 조인 버퍼
- 대표적인 로컬 메모리 영역은 다음과 같다
  - 소트 버퍼
  - 조인 버퍼
  - 바이너리 로그 캐시
  - 네트워크 버퍼

### 플러그인 스토리지 엔진 모델

![Plugin Storage](./images/mysql_plugin_storage.png)

- MySQL 의 독특한 구조중 대표적인 것 => 플러그인 모델
- 플러그인으로 사용가능한 것은 스토리지 엔진 만이 아니다
  - 전문 검색을 위한 검색어 파서
  - 사용자 인증을 위한 것들도 모두 플러그인으로 제공
- 다른 개발회사 또는 사용자가 직접 스토리지 엔진을 개발하는 것도 가능하다

`MySQL 쿼리가 실행되는 과정`

![MySQL Query](./images/mysql_engine_mysql_storage_engine.png)

- MySQL 쿼리 실행과정은 위와 같은데, 대부분의 작업이 MySQL 엔진에서 실행되고, 데이터 읽기/쓰기 작업만 스토리지 엔진에 의해 처리된다
- 스토리지 엔진을 만든다 => DBMS 의 일부분의 기능을 수행하는 엔진을 만든다 와 동일하다

> 데이터 읽기/쓰기 작업은 대부분 1건의 레코드 단위로 처리된다.

`MySQL Handler`
- MySQL 엔진에 스토리지 엔진을 조정하기 위해 핸들러 라는것을 사용하게 된다
  - 데이터를 읽어오거나 저장하도록 명령하려면 반드시 핸들러를 통해야 한다

- 스토리지 엔진이 다르다는 것은 **읽기/쓰기 작업에 대한 처리** 만 다를뿐 실제 쿼리를 실행하더라도 대부분 동일하다

`MySQL 지원 스토리지 엔진 목록`

```sql
mysql> show engines;
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |
| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |
| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |
| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |
| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |
| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |
| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |
| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |
| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
9 rows in set (0.00 sec)
```
- Support 칼럼에 표시 가능한 값
  - YES
    - MySQL 서버에 해당 엔진이 포함되어 있고, 활성화된 상태
  - DEFAULT
    - YES 와 동일하지만 필수 스토리지 엔진
  - NO
    - MySQL 서버에 포함되지 않음
  - DISABLED
    - MySQL 서버에는 포함되지만 비활성화된 상태

`MySQL 지원 플러그인 목록`

```sql
mysql> show plugins;
+---------------------------------+----------+--------------------+---------+---------+
| Name                            | Status   | Type               | Library | License |
+---------------------------------+----------+--------------------+---------+---------+
| binlog                          | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| mysql_native_password           | ACTIVE   | AUTHENTICATION     | NULL    | GPL     |
| sha256_password                 | ACTIVE   | AUTHENTICATION     | NULL    | GPL     |
| caching_sha2_password           | ACTIVE   | AUTHENTICATION     | NULL    | GPL     |
| sha2_cache_cleaner              | ACTIVE   | AUDIT              | NULL    | GPL     |
| CSV                             | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| MEMORY                          | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| InnoDB                          | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| INNODB_TRX                      | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CMP                      | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CMP_RESET                | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CMPMEM                   | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CMPMEM_RESET             | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CMP_PER_INDEX            | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CMP_PER_INDEX_RESET      | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_BUFFER_PAGE              | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_BUFFER_PAGE_LRU          | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_BUFFER_POOL_STATS        | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_TEMP_TABLE_INFO          | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_METRICS                  | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_FT_DEFAULT_STOPWORD      | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_FT_DELETED               | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_FT_BEING_DELETED         | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_FT_CONFIG                | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_FT_INDEX_CACHE           | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_FT_INDEX_TABLE           | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_TABLES                   | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_TABLESTATS               | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_INDEXES                  | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_TABLESPACES              | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_COLUMNS                  | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_VIRTUAL                  | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_CACHED_INDEXES           | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| INNODB_SESSION_TEMP_TABLESPACES | ACTIVE   | INFORMATION SCHEMA | NULL    | GPL     |
| MyISAM                          | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| MRG_MYISAM                      | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| PERFORMANCE_SCHEMA              | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| TempTable                       | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| ARCHIVE                         | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| BLACKHOLE                       | ACTIVE   | STORAGE ENGINE     | NULL    | GPL     |
| FEDERATED                       | DISABLED | STORAGE ENGINE     | NULL    | GPL     |
| ngram                           | ACTIVE   | FTPARSER           | NULL    | GPL     |
| mysqlx_cache_cleaner            | ACTIVE   | AUDIT              | NULL    | GPL     |
| mysqlx                          | ACTIVE   | DAEMON             | NULL    | GPL     |
+---------------------------------+----------+--------------------+---------+---------+
```

> MySQL 은 스토리지 엔진 뿐 아닌 다양한 기능을 플러그인으로 지원한다