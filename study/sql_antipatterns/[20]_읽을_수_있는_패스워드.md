# 지옥 스터디 - 20 읽을 수 있는 패스워드

## 목표 : 패스워드를 복구하거나 재설정 하기
- 대부분 현대적 애플리케이션에서는 이메일 피드백을 통해 패스워드 복구/재설정을 진행한다.
- 이 방법은 사용자의 이메일 주소를 사용한다.

## 안티패턴 : 패스워드를 평문으로 저장하기
- 패스워드 복구 방법에서 가장 흔한 실수는 사용자가, 자신의 패스워드를 평문으로 담은 이메일을 요청할 수 있도록 하는 것이다.
- 데이터베이스 설계와 관련된 심각한 보안 결함이고, 인증 받지 않은 사람이 애플리케이션에 접근 궎나을 얻을 수 있는 위험을 초래한다.

### 패스워드 저장
- 패스워드는 보통 Accounts 테이블에 문자열 속성 칼럼으로 저장된다.

```sql
CREATE TABLE Accounts (
    account_id SERIAL PRIMARY KEY,
    account_name VARCHAR (20),
    email VARCHAR(100),
    password VARCHAR (30)
);
```
- 패스워드를 평문으로 저장하거나 평문 상태로 네트워크를 통해 전달하는 것은 안전하지 않다.
- 공격자가 삽입에 사용한 SQL 문을 가로채서 읽을 수 있다면, 패스워드가 그대로 노출된다.

### 패스워드 인증
- 사용자가 로그인 시도시 애플리케이션은 사용자의 입력과 데이터베이스에 저장된 패스워드 문자열을 비교한다.
- 패스워드가 평문으로 저장되어 있는 경우 이 비교도 평문으로 수행된다.

```sql
SELECT CASE WHEN password = 'opensesame' THEN 1 ELSE 0 END
FROM Accounts
WHERE account_id = 123;
```
- 위 예제는 사용자가 입력한 opensesame 는 데이터베이스에 저장된 값과 다르다면 쿼리는 0을 리턴한다.
- 이는 공격자에게 패스워드가 노출될 위험이 증가한다.

### 이메일로 패스워드 보내기
- 패스워드가 데이터베이스에 평문으로 저장되었기 때문에, 애플리케이션에서 패스워드를 검색하는 것도 간단하다.

```sql
SELECT account_name, email, password
FROM Accounts
WHERE account_id = 123;
```
- 패스워드를 평문으로 담고 있는 이메일을 보내는 것은 보안에 심각한 위험이 된다.
- 이메일은 해커가 여러 가지 방법을 통해 가로채거나, 로깅하거나, 저장할 수 있다.
- 보안 프로토콜 정도로는 보호하기 충분하지 않다.

## 안티패턴 인식 방법
- 패스워드 복구시 패스워드를 평문으로 저장하거나 역변환 가능한 암호화 기법을 사용하는 것이다.
- 이는 안티패턴이다.
- 애플리케이션에서 읽을 수 있다면 해커도 읽는 것이 가능해진다.

## 안티패턴 사용이 합당한 경우
- 애플리케이션에서 패스워드를 이용해 다른 서드파티 서비스에 접근해야할 경우이다.
- 이런 경우 읽을 수 있는 형태로 저장해야 한다.
- 하지만 평문 저장보단 암호화 기법을 사용하는 것이 더 좋다.

## 해법 : 패스워드의 소금 친 해시 값을 저장한다.

### 해시 함수 이해하기
- 일방향 해시 함수를 이용해 패스워드를 부호화 한다.
- 해시 함수는 입력한 문자열을 해시라 불리는 알아볼 수 없는 문자열로 변환한다.
- SHA-256 알고리즘이 대표적인 예
- 예전에는 SHA-1 이 인기있었으나 암호학적으로 강력하지 않아 추론이 가능해졌다.
- SHA-256, SHA-384, SHA-512 와 같은 좀 더 강력한 형태의 알고리즘을 궈낭한다.
- MD5 역시 인기있는 해시 함수로 128 비트 해시 값을 만든다.
- MD5 또한 암호학적으로 약하다는 것이 증명되었으며 패스워드를 부호화하는 데 사용하면 안된다.

### SQL 에서 해시 사용하기
- SHR-256 사용시 64자가 고정이기에 CHAR (64) 를 패스워드 해시 컬럼으로 사용한다. 
```sql
CREATE TABLE Accounts (
    account_id SERIAL PRIMARY KEY,
    account_name VARCHAR(20),
    email VARCHAR(100),
    password_hash CHAR(64)
)
```
- 해시 함수는 SQL 표준이 포함되지 않으므로 데이터베이스에서 제공하는 기능을 사용해야 한다.
- MySQL 에서는 SHA2() 함수를 사용할 수 있다.

### 해시에 소금 추가하기
- 패스워드 대신 해시 값을 저장했더라도 공격자가 데이터베이스에 접근 했다면 패스워드를 알아낼 수도 있다.
- 이런 경우를 방지하는 것 중하나는 패스워드 부호화시 **소금 (salt)** 를 추가하는 것이다.
- 소금은 해시 값을 구하기 전 사용자의 패스워드에 덧붙이는 무의미한 바이트열이다.
- 사전에 있는 단어를 패스워드로 사용한다 해도 소금을 친 패스워드를 이용해 만든 해시 값을 일치하지 않을 수 있다.
- 소금은 8바이트 정도로 충분하며, 각 패스워드에 대해 임의로 소금 값을 생성해야 한다.

### SQL 에서 패스워드 숨기기
- 웹 애플리케이션에서 공격자가 네트워크에서 데이터를 가로챌 수 있는 다른 곳이 있다.
- 브라우저와 웹 애플리케이션 서버 사이이다.
- 항상 HTTPS 같은 보안 프로토콜을 사용하는 것이 좋다.

### 패스워드 복구가 아닌 패스워드 재설정 사용하기
- 패스워드가 안전하게 저장되어 있지만, 패스워드 잊어버렷을때의 처리도 필요하다.
- 해시값이 저장되어 있으므로 원래 패스워드를 알수 없다.
- 대안으로 사용자에게 임시 패스워드를 발급해 주는 것이다.
- 또 다른 방법은 이메일에 새로운 패스워드를 할당해주고 요청을 DB 에 기록한 뒤 유일한 토큰을 할당하는 것이다.
- 그런 다음 토큰을 이메일로 보낸다.

> 당신이 패스워드를 읽을 수 있다면, 해커도 읽을 수 있다.