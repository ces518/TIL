# 지옥 스터디 - 21 SQL 인젝션

## 목표 : 동적 SQL 쿼리 작성하기
- 쿼리 문자열과 애플리케이션 변수를 섞어 SQL 문자열로 만드는 것을 보통 **동적 SQL (Dynamic SQL)** 이라 한다.
- 동적 SQL 쿼리는 데이터베이스로 부터 최대 효과를 얻으려 할 때 쓰는 자연스러운 방법.
- 이런 작업을 하도록 하는 것은 쉽다.
- 하지만 소프트웨어를 안전하게 만들어 우리가 원치 않는 동작을 헝요하지 않도록 하는 것은 어렵다.
- SQL 인젝션의 결과로 인한 소프트웨어 결함은 이를 만족시키는 데 실패해 생기는 것이다.

## 안티패턴 : 검증되지 않은 입력을 코드로 실행하기
- SQL 인젝션은 어떤 내용을 SQL 쿼리 문자열에 삽입해 쿼리의 동작을 원래 의도와 다르게 수정하는 것이다.
- SQL 인젝션의 고전적인 예는, SQL 에 상비되는 문자열에 세미콜론을 넣어 SQL 문장을 끝내고 둗번 째 문장을 실행하도록 하는 것이다.

```sql
SELECT * FROM Bugs WHERE bug_id = 1234; DELETE FROM Bugs
```

### 사고는 발생할 것이다.
- 버그 데이터베이스를 보는 웹 인터페이스를 작성하고 있고, 프로젝트 이름으로 프로젝트 정보를 볼 수 있는 페이지를 만들고 있다.
- 시카고에 잇는 오헤어 (O'Hare) 국제 종항에서 사용할 소프트웨어를 개발할때 문제가 생긴다.
- 자연스럽게 프로젝트 명을 오헤어로 지었지만, 프로젝트 정보보기 제출시 다음과 같은 일이 생긴다.

```text
http://bugs.example.com/project/view.phph?name=O'Hare
```

```sql
SELECT * FROM Projects WHERE project_name = 'O'Hare'
```
- 위와 같이 의도치 않은 형태로 변경되게 된다.
- 이는 데이터베이스 에서는 문법 에러가 발생한다.
- 문법에러는 사고치곤 운이 좋은 에러이다.
- 큰 위험은 **의도치 않은 문장이 실행** 되는 문제이다.

### 최고의 웹 보안 위험
- 공격자가 SQL 인젝션을 이용해 SQL 문을 조작할 수 있게 되면 심각한 위험이 있다.
- 요청 파라미터가 SQL 에서 어떻게 사용되는지 추측이 가능하면 이를 이용해 공격을 시도한다.

```text
http://bugs.example.com/setpass?password=xyzzy&userid=123 OR TRUE
```

```sql
UPDATE Accounts SET password_hash = SHA2('xyzzy')
WHERE account_id = 123 OR TRUE;
```
- 위의 경우는 모든 계정의 패스워드가 변경되게 된다.
- 바로 이점이 SQL 인젝션을 이해하고 어떻게 대응해야할지 아는 핵심이다.
- SQL 인젝션은 **파싱되기 전 SQL 문을 조작하는 방법으로 동작** 한다.
- SQL 파싱 전 동적인 부분을 삽입한다면 SQL 인젝션 위험이 있는 것이다.

### 치료를 위한 탐구
- 코드를 이용당하지 않도록 보호하려면 어떻게 해야 하는가 ?

`값을 이스케이프 하기`
- SQL 쿼리를 보호하는 가장 고전적인 방법은 따옴표 문자가 문자열의 마지막이 되지 않도록 모든 따옴표를 이스케이프 처리 하는 것이다.

```sql
SELECT * FROM Proejcts WHERE project_name = 'O\'Hare'
```

`쿼리 파라미터`
- SQL 인젝션에 대한 만병통치약으로 자주 인용되는 것은 **쿼리 파라미터** 를 사용한느 방법
- 동적값 삽입 되신 쿼리를 만들 때 파라미터가 들어갈 자리를 미리 정의하는 것이다.

```sql
SELECT * FROM Projects WHERE proejct_name = ?;
```
- 많은 프로그래머가 이 방법을 권고한다.
- 내용을 이스케이프 할 필요도 없고, 함수의 결함을 걱정하지 않아도 된다.
- 이 방법은 SQL 인젝션에 대해 매우 강력한 방어가 된다.
- 하지만 이 방법이 보편적인 해결방법이 될 수는 없다.
- 값의 목록이나 테이블 이름은 파라미터로 전달할 수 없다.

> 동적 SQL 을 디버깅하는 가장 좋은 방법 => 파라미터 자리를 가진 SQL 과 실행시 파라미터 값을 모두 로깅하는 것

`저장 프로시저`
- 저장 프로시저는 SQL 인젝션에 대응하는 매우 강력한 방법이라 많은 개발자가 주장한다.
- 일반적으로 저장 프로시저는 고정된 SQL 을 포함하며, 프로시저 정의시 파싱된다.
- 하지만 프로시저 내에서도 안전하지 않은 방법으로 동적 SQL 을 사용할 수 있따.

```sql
CREATE PROCEDURE UpdatePassword (input_password VARCHAR(20), ionput_userid VARCHAR(20))
BEGIN
    @sql = CONCAT ('UPDATE Accounts SET password_hash = SHA2(', QUOTE(input_password),')
    WHERE account_id = ', input_userid);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
END
```
- 저장 프로시저 내에서 동적 SQL 을 사용하는 것은 애플리케이션 내에서 사용하는 것과 마찬가지로 위험하다.

`데이터 접근 프레임워크`
- 데이터 접근 프레임워크 옹호자들이 자신들의 라이브러리가 SQL 인젝션으로 부터 보호해준다는 것을 많이 보았다.
- SQL 문을 문자열로 작성하는것을 헝요한다면 어떤 프레임워크던 이는 틀ㄹ니 것이다.
- 어떤 프레임워크도 안전한 SQL 코드만 작성하도록 강제할 수 없다.
- 프레임워크는 개발자를 돕기위한 편리한 함수를 제공할 수도 있지만, 이런 함수를 쉽게 우회해 안전하지 않은 SQL 문을 만드는 문자열 조작을 사용할 수 있다.

## 안티패턴 인식 방법
- 실질적으로 모든 데이터베이스 애플리케이션은 SQL 문을 동적으로 생성한다.
- SQL 문 어느부분이든 문자열을 연결하거나 값을 문자열에 삽입해 만든다면 이런 애플리케이션은 잠재적인 SQL 인젝션에 노출된 것이다.

## 안티패턴 사용이 합당한 경우
- SQL 인젝션으로 인한 보안 취약점을 허용할 합당한 이유는 없다.
- 코드를 방어적으로 작성하고, 동료들 또한 그렇게 하도록 돕는 것이 개발자로서의 책임이다.

## 해법 : 아무도 믿지 마라
- 하나의 기술로 SQL 을 안전하게 만드는 방법은 없다.
- 다음 기법들을 모두 배우고 적절한 경우에 사용해야 한다.

### 입력값 필터링
- 어떤 입력이 해로운 내용을 가지고 있을지 걱정만 하지 말고, 해당 입력에 대해 유효하지 않은 문자는 모두 제거해야 한다.
- 숫자가 필요하다면 숫자만 필터링 처리를 해야 한다.

### 파라미터를 통한 값 전달
- 쿼리의 동적인 부분이 단순한 값이면, 쿼리 파라미터를 사용해 다른 SQL 표현과 분리해야 한다.
- 파라미터가 있는 SQL 문을 DBMS 가 파싱하고 나면 어떤 SQL 인젝션 공격도 쿼리르 바꿀 수 없다.
- 애플리케이션 변수를 SQL 문의 리터럴 값으로 엮어야 한다면, 쿼리 파라미터를 사용해야 한다.

### 동적 값 인용하기
- 쿼리 파라미터를 사용하는 것은 최상의 방법이지만, 쿼리 파라미터 사용으로 인해 옵티마이저가 어떤 인덱스를 사용할지 잘못된 판단을 할 수 있다.
- 쿼리 파라미터는 일반적인 권장사항 이지만, 특별한 경우에는 SQL 문제 값을 직접 삽입하는 것이 나을 수도 있다.

```sql
SELECT * FROM Accounts
WHERE is_active = ? -- (true/false) 값을 가짐
```
- 위 쿼리는 쿼리 준비 (prepare) 단계에서 어떤 파라미터가 들어올지 알 수 없기 때문에 잘못된 계획을 선택할 수 있다.

### 사용자의 입력을 코드와 격리하기
- 요청 파라미터로 미리 정의된 값을 검색하게 하고 이 값을 SQL 쿼리에 사용하도록 하는 방법이다.
- 이 방법은 몇 가지 장점이 있다.
- 사용자 입력을 SQL 쿼리와 직접 엮지 않으므로, SQL 인젝션 위험이 줄어든다.
- 식별자, SQL 키워드, 전체 수직까지 SQL 어떤 부분이든 동적으로 만들 수 있다.
- 사용자 입력이 유효한지 확인하기가 쉽고 효율적이다.
- 데이터베이스 쿼리의 내부 상세사항을 사용자 인터페이스 에서 분리한다.
- 선택 가능한 값이 애플리케이션에 **하드코딩** 되어 있지만, 테이블 이름, 칼럼 이름, SQL 키워드에 대해 적절한 것이다.

### 코드 검토를 함께할 동료 구하기
- 결함을 잡아내는 가장 좋은 방법 => 다른 사람과 함께 코드 검톻기
- SQL 인젝션에 익숙한 팀 도욜에서 같이 코드를 함께 검사하도록 부탁하자.
- **자존심** 떄문에 올바른 일을 하지 못하면 안된다.
- SQL 인젝션에 대한 검사시, 다음 가이드 라인을 따를 것을 권장
1. 애플리케이션 변수, 문자열 연결 또는 치환을 통해 생성되는 SQL 문을 찾는다.
2. SQL 문에서 사용되는 모든 동적 내용의 출처를 추적해, 사용자 입력, 파일, 환경 변수, 웹 서비스, 서드파티 코드, 데이터베이스로 얻어온 문자열 까지 외부로부터 오는 모든 데이터를 찾는다.
3. 외부로부터 오는 데이터는 잠재적으로 위험하다고 가정한다. 필터/유효성 검사기/매핑 배열 을 통해 신뢰할 수 없는 데이터를 변환한다.
4. 외부 데이터를 SQL 문과 연결할 때는 쿼리 파라미터나 견고한 이스케이프 함수를 사용한다.
5. 저장 프로시저나 동적 SQL 문을 찾을 수 있는 다른 부분에 대한 코드 검사도 잊지 않는다.

코드 검사는 SQL 인젝션을 찾는 가장 정확하고 경제적인 방법이다. 코드 검사를 위한 시간을 확보하고, 이를 필수 활동으로 생각해야 한다.

> 사용자가 값을 입력하게 하라. 하지만 코드를 입력하게 해서는 안된다.