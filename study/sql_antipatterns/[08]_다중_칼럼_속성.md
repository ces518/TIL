# 지옥 스터디 - 08 다중 칼럼 속성
- 전화번호는 집 전화번호, 회사 전화번호, 팩스 번호, 휴대폰 번호가 일반적이다.
- 얀락처 정보 테이블에서 네 개의 칼럼으로 이런것들을 저장하기 쉽다.
- 하지만 다른번호가 나온다면 어떻게 해야하는가 ?
- 개인용 단말번호나 보조 휴대폰, 현장 사무실 등 예상치 못한 범주가 있을 수 있다.
- 단순 칼럼추가로만 해결할수만은없는 경우가 발생할 수도 있다.

## 목표 : 다중 값 속성 저장
- 2장 무단횡단 안티패턴에서와 같은 목표
- 속성이 한 테이블에 들어가야할 것처럼 보이지만 여러 개의 값을 가진다.
- 여러 값을 쉼표로 구분된 문자열로 묶어 저장했을 때는 유효성 확인이 어렵다.

## 안티패턴 : 여러 개의 칼럼 생성
- 속성에 여러 값이 들어가는 것을 고려해야 하지만, 각 칼럼에는 하나의 값만을 저장해야 한다는 것을 알고 있다.
- 테이블에 여러 개의 칼럼을 만들고 각 칼럼에 하나의 태그를 저장하는 것이 자연스럽다.

```sql
CREATE TABLE Bugs (
    bug_id SERIAL PRIMARY KEY,
    description VARCHAR (1000),
    tag1 VARCHAR (20),
    tag2 VARCHAR (20),
    tag3 VARCHAR (20)
);
```
- 주어진 버그에 태그를 달 때 위 세칼럼중 하나에 값을 넣고, 사용중이지 않는 태그에는 NULL 을 집어 넣는다.

### 값 검색
- 주어진 태그를 가진 버그를 조회하려면 **세 칼럼 모두 확인** 해야 하낟.
- 어느 컬럼에 태그 문자열이 존재하는지 알 수 없다.

```sql
SELECT * FROM Bugs
WHERE tag1 = 'performance'
OR tag2 = 'performance'
OR tag3 = 'performance'
```
- performance 라는 태그를 가진 버그를 조회하려면 위와같이 쿼리해야 한다.

### 값 추가와 삭제
- 칼럼 집합에 값을 추가하거나 삭제하는 것도 문제다.
- 어느 칼럼이 비어있는지 알 수 없기 때문에 단순 UPDATE 를 사용해 칼럼중 하나를 변경하는것은 안전하지 않다.
- 매번 애플리케이션에서 해당 로우를 조회해야 한다.

```sql
SELECT * FROM Bugs WHERE bug_id = 3456;

UPDATE Bugs SET tag2 = 'performance' WHERE bug_id = 3456;
```

### 유일성 보장
- 여러 칼럼에 동일한 값이 나타나지 않게 하고 싶겠지만, 다중 칼럼 속성 안티패턴을 사용한다면 데이터베이스에서 이를 예방하지 못한다.
- 다음과 같은 쿼리가 실행되는 것을 방지하지 못한다는 의미

```sql
INSERT INTO Bugs VALUES ('printing is slow', 'printing', 'performance', 'performance');
```

### 값의 수 증가 처리
- 이 설계의 단점은 칼럼 세개로 충분하지 않은 경우가 있다는 점이다.
- 버그가 가질수 있는 태그 수만큼 칼럼을 정의해야 한다는 것
- 테이블 정의시점에 최대 개수가 몇개인지 어떻게 예측가능한가 ?
- 최초에 적덩한 개수를 추가한 뒤 필요시 칼럼을 추가해 확장하는 것... ?
- 하지만 이는 비용이 많이드는 작업이다.
  - 이미 데이터가 존재하는 데이터베이스 구조를 변경하려면 락이 필요하다.
  - 테이블을 복사해 이관하는 식으로 테이블 변경을 구현하는 데이터베이스도 있다.
  - 데이터가 많다면 부하가 상당하다.
  - 다중칼럼속성 집합에 칼럼을 추가한 경우 모든 애플리케이션의 SQL 을 변경해야 한다.

```sql
SELECT * FROM Bugs
WHERE tag1 = 'performance'
OR tag2 = 'performance'
OR tag3 = 'performance'
OR tag4 = 'performance'; 
```
- 이는 발견하기 힘든 버그가 발생할 확률이 크다.

## 안티패턴 인식 방법
- 사용자 인터페이스나 문서에 여러 개의 값을 할당할 수 있지만 최대 개수가 제한된 속성이 기술되어 있다면
- 다중 칼럼 속성 안티패턴을 사용중일 가능성이 크다.
- 또 다른 징조는 다음과 같은 말이 들리는 경우이다.
  - 태그를 최대 몇개까지 지원해야 하는가 ?
  - SQL 에서 여러 칼럼을 한번에 검색하려면 어떻게 해야하지 ?

## 안티패턴 사용이 합당한 경우
- 속성의 개수가 고정되고 선택의 위치나 순서가 중요할 수도 있다.
- 각 속성을 따로따로 사용하는 경우 지금까지 설명한 결점이 중요하지 않다.

## 해법 : 종속 테이블 생성
- 가장 좋은 해법은 다중 값 속성을 위한 칼럼을 하나 가지는 종속 테이블을 만드는 것이다.
- 여러 개의 값을 칼럼 대신 여러 개의 행에 저장하는 것이다.
- 종속 테이블에 FK 를 선언해 해당 값이 부모와 연관되도록 한다.

```sql
CREATE TABLE Tags (
    bug_id BIGINT NOT NULL,
    tag VARCHAR(20),
    ...
);

INSERT INTO Tags (bug_id, tag)
VALUES (1234, 'crash'), (3456, 'printing');
```
- 하나의 버그에 연관된 태그가 한 칼럼에 있다면 검색하는 작업이 좀 더 직관적이 된다.

```sql
SELECT * FROM Bugs JOIN Tags USING (bug_id)
WHERE tag = 'performance';
```
- 관계를 추가하고 삭제하기도 다중 칼럼 안티패ㅓㄴ보다 훨씬 쉬워진다.

> 같은 의미를 가지는 각각의 값은 하나의 칼럼에 저장하라.
