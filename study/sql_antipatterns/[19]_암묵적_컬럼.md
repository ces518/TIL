# 지옥 스터디 - 19 암묵적 칼럼

```sql
SELECT * FROM Books b JOIN Authors a ON b.author_id = a.author_id;
```
- 위 쿼리는 모든 책 제목이 NULL 로 리턴된다.
- 이상한 것은 Authors 와 조인하지 않으면 기대한 대로 책 제목이 나온다는 점이다.
- 이유 ? -> Book.title / Author.title 컬럼명이 겹쳐 PHP 와 같은 언어에서 연관 배열로 리턴하는 경우 NULL 이 나올 수 있다는 것이었다.

## 목표 : 타이핑 줄이기
- 소프트웨어 개발자들은 타이핑을 좋아하지 않는다.
  - 자신들의 직업 선택과는 모순됨.
- 타이밍을 많이해야 한다고 불평하는 것 중 하나는 사용할 모든 컬럼을 SQL 쿼리에 써야하는 경우이다.

```sql
SELECT bug_id, date_reported, summary, description, resolution, reported_by, assigned_to, verified_by, status, priority, hours
FROM Bugs;
```
- 개발자들이 SQL 와일드 카드를 사용하는 것은 놀랄만한 일이 아니다.
- 와일드카드를 사용할 경우 칼럼 목록은 명시적이 아닌 **암묵적** 이다.
- 이는 쿼리를 간결하게 하는데 도움이 된다.

```sql
SELECT * FROM Bugs;
```

## 안티패턴 : 지름길만 좋아하면 길을 잃는다.
- 칼럼 이름 없이 와일드카드를 사용하면 타이핑은 줄지만, 이런 습관은 몇 가지 위험을 초래한다.

### 리팩터링 방해
- Bugs 테이블에 일정 관리를 위해 date_due 칼럼을 추가해야 한다고 가정.

```sql
ALTER TABLE Bugs ADD COLUMN date_due DATE;
```
- 암묵적 칼럼을 사용하는 INSERT 문에서는 테이블의 모든 칼럼에 대한 값을 테이블에 정의된 순서대로 지정해야 한다.
- 칼럼이 바뀌면 INSERT 문에서 에러가 발생하거나 엉뚱한 칼럼에 값을 할당할 수 있다.
- 또한 칼럼 이름이 바뀌거나, 추가/삭제되면 쿼리 결과가 애플리케이션 코드에서 지원하지 않는 방식으로 바뀔 수 있다.
- 와일드 카드 사용시 몇 개의 칼럼을 리턴하는지 예상할 수 없다.

### 숨겨진 비용
- 쿼리에서 와일드카드를 사용하는 것은 성능과 확장적응성에 해를 끼칠수 있다.
- 쿼리에서 더 많은 컬럼을 선택하면 데이터베이스 서버와 애플리케이션 사이의 네트워크를 통해 더 많은 데이터가 전달되어야 한다.
- 실 환경에서는 많은 쿼리가 동시에 실행될 것이다.
- 수백개의 애플리케이션 클라이언트가 동시에 수천행을 리턴하는 쿼리를 실행하면 기가비트 네트워크 조차도 포화상태가 될 수 있다.

### 요청한 것을 얻은 것이다.
- SQL 와일드카드를 사용하는 것과 관련해 흔한 질문중 하나 -> 지정한 몇 개 칼럼을 제외한 모든 칼럼을 요청하는 쉬운 방법이 있는가 ?
- 그런 방법은 없다.
- 원하는 칼럼 목록을 명시적으로 나열해야 한다.

## 안티패턴 인식 방법
- 다음은 암묵적 컬럼 안티패턴을 사용하고 있음을 나타낸다.
  - 애플리케이션이 여전히 데이터베이스 칼럼을 예전 이름으로 참조해 동작하지 않아.
  - 네트워크 병목을 추적하는데 며칠이 걸렸고, 마침내 데이터베이스 서버 의 과도한 트래픽 문제로 범위를 좁혔어.

## 안티패턴 사용이 합당한 경우
- 테스트용도와 같이 임시 SQL 이라면 와일드카드 사용을 정당화할 수 있다.
- 한번 사용할 쿼리라면 유지보수성은 중요하지 않다.
- 실행 효율보다 개발 효율이 중요하다면 와일드카드를 사용할 수 있다.

## 해법 : 명시적으로 칼럼 이름 지정하기
- 와일드카드나 암묵적 칼럼 목록에 의지하기 보다 항상 필요한 칼럼을 나열해야 한다.

### 오류 검증
- 포카요케 (poka-yoke)
- 쿼리의 SELECT 목록에 칼럼을 지정하면 SQL 쿼리가 에러나 앞서 설명한 혼동에 대해 저향력이 생긴다.
  - 테이블에서 칼럼 위치가 바뀌어도 쿼리결과에선 바뀌지 않는다.
  - 칼럼이 추가되어도 쿼리 결과에서는 나타나지 않는다.
  - 칼럼 삭제가 에러를 발생시킨다. 이는 좋은 에러이다. 코드를 고쳐야할 위치를 직접 알려주기 때문이다.
- 이것이 "빨리 실패하라" 원칙의 예이다.

### 그거 필요하지 않을 꺼야
- 네트워크 대역폭을 낭비할 가능성이 있는 곳을 살펴보아야 한다.
- 개발/테스트 단계에서는 대역폭이 문제 없어 보이지만, 초당 수천개의 쿼리가 실행되는 실 환경에서는 문제가 될 수 있다.
- 와일드 카드를 포기하면 대역폭을 보다 효율적으로 사용하게 된다.

### 어쨋든 와일드카드를 포기해야 돼
- SQL 에서 특정 칼럼에 수식을 적용하거나, 칼럼에 별칭을 지정하거나, 효율을 위해 칼럼을 제거하려면 와일드카드를 포기해야 한다.

> 원하는 대로 가져가라, 그러나 가져간 건 다 먹어야 한다.