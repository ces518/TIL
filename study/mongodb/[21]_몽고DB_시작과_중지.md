# 21장 몽고DB 시작과 중지
- 주로 사용하는 옵션
- 몽고 DB 시작과 중지
- 보안 관련 옵션
- 로깅 고려 사항

## 명령행에서 시작하기
- 몽고 DB 서버는 mongod 시작하며 시작시 구성 가능한 다양한 옵션이 있다
  - `--help` 로 확인 가능
- 몇가지 주요 옵션을 살펴 보자
  - `--dbpath`
    - 데이터 디렉터리로 상욯나 경로 지정
    - 기본 값 => /data/db
    - 동일 서버내 각 mongod 프로세스는 각 별도 데이터 디렉터리를 사용한다
  - `--port`
    - 서버 연결에 사용할 포트를 지정한다
    - 기본 값 => 27017
  - `--fork`
    - 유닉스 기반 시스템에서 서버 프로세스를 포크해서 데몬으로 실행한다
    - `--logpath` 와 함께 사용해야 로그로 추적이 가능하다
  - `--logpath`
    - 모든출력을 별도 로그 파일로 출력한다
    - 이미 로그 파일이 존재한다면 덮어 쓰기 때문에, 이전 로그를 보존하려면 `--logappend` 옵션을 사용해야 한다
  - `--directoryperdb`
    - 각 데이터베이스를 자신의 디렉터리에 저장한다
    - 필요시 다른 디스크 상의 데이터베이스를 마운트 할 수 있다
    - 일반적으로 로컬 DB 를 디스크에 올리거나 디스크가 가득 차 다른 디스크로 이동하는 용도로 사용 된다
  - `--config`
    - 명령행에서 지정하지 않은 옵션을 설정 파일을 통해 구성한다
- 데이터베이스 시작시 몽고 DB 는 버전, 기반 시스템, 사용된 플래그를 설명하는 `local.startup_log` 컬렉션에 도큐먼트를 쓴다
- 이 컬렉션은 업그레이드와 변화 추적시 용이하다

### 파일 기반 구성
- 몽고 DB 는 파일로부터 구성 정보를 로드하는 기능을 지원한다
- 구성 파일에서 지원하는 옵션은 명령행에서 지원하는 옵션과 동일하지만 2.6 버전부터 yaml 파일을 사용한다

```yaml
systemLog:
  destination: file
  path : "mongod.log"
  logAppend : true
storage:
  dbPath: data/db
processManagement:
  fork: true
net:
  port: 5586
```
- 4.2 버전부터 특정 구성 파일 옵션이나 전체 구성 파일을 로드하도록 확장 지시자도 추가되었다
  - 암호 및 보안 인증서와 같은 기밀 정보를 구성 파일에 저장할 필요가 ㅇ벗다

## 몽고 DB 중지
- 실행중인 서버를 중지시키는 가장 명확한 방법 => shutdown 명령
  - {"shutdown" : 1}
  - 관리자 명령이며 admin 데이터베이스에서 실행해야 한다

```shell
use admin
db.shutdownServer()
```
- 프라이머리에서 shutdown 명령 실행시 강등 시킨이후 세컨더리가 따라잡도록 대기한다
- 몇초 내에 따라 잡을 수 있는 세컨더리가 없다면 실패한다
- `force` 옵션 사용시 프라이머리를 중지하도록 강제할 수 있다

```shell
db.adminCommand({"shutdown" : 1, "force" : true})
```
- SIGINT, SIGTERM 시그널을 보내는것과 동일하다
- mongodb 는 SIGINT, SIGTERM 를 받으면 안전하게 종료된다

## 보안
- 몽고 DB 와 외부 환경 사이의 연결을 가능한 엄격하게 제한해야 한다
- 가장 좋은 방법 => 방화벽 구성 및 몽고 DB 만 내부 네트워크에 도달하는 방법
- 구성파일에 옵션을 추가해 방화벽 이상으로 보안을 강화할 수 있다
    - `--bind_ip`
      - 몽고 와 연결할 인터페이스를 지정한다
      - 일반적으로 내부 IP 사용
      - 3.6 부터 mongod, mongos 는 기본적으로 localhost 에 바인딩 된다
      - local 에만 바인딩 되면 mongod, mongos 는 동일 머신에서 실행한느 클라이언트의 연결만 허용한다
    - `nounixsocket`
    - `--noscripting`