# 7장 집계 프레임워크
- 집계 프레임워크
- 집계 단계
- 집계 표현식
- 집계 누산기

## 파이프라인, 단계 및 조정 가능 항목
- 집계 프레임워크는 몽고 DB 내 분석도구 이며, 하나 이상의 컬렉션에 있는 도큐먼트에 대한 분석을 수행한다
- 이는 파이프라인 개념을 기반으로 한다.
- 집계 파이프라인을 통해 컬렉션으로 부터 입력을 받고, 컬렉션에서 나온 도큐먼트를 하나 이상의 단계를 거쳐 전달하며 단계마다 해당 입력에 다른 작업을 수행한다
- 집계 파이프라인은 배시와 같은 리눅스 셸 파이프라인과 매우 유사한 개념이며, 단계마다 특정 작업을 수행한다
- 집계 파이프라인의 개별 단계는 **데이터 처리 단위** 이다.
- 한 번에 입력 도큐먼트 스트림을 하나씩 가져와 각 도큐먼트를 하나씩 처리하고, 출력 도큐먼트 스트림을 하나씩 생성한다
- 각 단계는 knobs or tunables 셋을 제공한다
- 이 항목들을 조정해 각 단계를 매개변수로 지정함으로써 원하는 작업을 수행할 수 있다
- tunables 는 일반적인 필드 수정, 산술 연산 수행, 도큐먼트 재구성, 일정의 누산 작업등 여러 작업을 수행하는 연산자의 형태를 취한다

`요약`
- 파이프라인은 컬렉션과 함께 동작한다
- 파이프라인은 각 단계로 구성되며 각 단계는 입력에 서로 다른 데이터 처리 작업을 수행하고, 출력으로 도큐먼트를 생성해 다음 단계로 전달한다
- 처리 작업 끝에서 생성한 출력은 애플리케이션에서 작업하는 데 사용하거나, 컬렉션에 보내 나중에 사용한다
- 많은 경우 필요한 분석을 수행하기 위해 단일 파이프라인에 동일한 유형의 단계를 여러번 포함한다

## 단계 시작하기 : 익숙한 작업들
- 집계 파이프라인 개발 전 익숙한 몇몇 파이프라인의 구축을 살펴본다
- 일치, 선출, 정렬, 스킵, 제한 단계를 살펴본다
- **일치 단계** 는 컬렉션에 대해 필터링하고 결과 도큐먼트를 한 번에 하나씩 선출 단계로 전달한다
- **선출 단계** 는 작업을 수행하고 도큐먼트 모양을 변경한 후 출력을 파이프라인에서 다시 우리에게 전달한다
- **제한 단계** 는 결과 갯수를 제한한다
- 만약 순서가 중요하다면, 제한 단계 이전에 **정렬** 을 수행해야 한다

```shell
db.companies.aggregate([
  {"$match" : {"founded_year" : 2004}},
  {"$sort" : {"name" : 1}},
  {"$skip" : 10},
  {"$limit" : 5},
  {"$project" : {
    "_id" : 0,
    name : 1
  }}
])
```
- match : 일치 단계
- sort : 정렬 단계
- skip : 스킵 단계
- limit : 제한 단계
- project : 프로젝션 ( 필요한 필드만 포함 시킨다. 예제에서는 _id 필드 제외, name 필드 포함

## 표현식
- 집계 파이프라인을 구축할 때 사용할 수 있는 다양한 유형의 표현식을 이해하는 것이 중요하다
- 집계 프레임워크는 다양한 표현식 클래스를 제공한다
- 불리언 표현식
  - AND, OR, NOT
- 집합 표현식
  - 배열을 집합으로 사용할 수 있다
  - 2개 이상의 집합의 교집합이나 합집합을 얻을 수 있다
  - 두 집합의 차를 이용해 여러 집합 연산을 수행할 수 있다
- 비교 표현식
  - 다양한 유형의 범위 필터를 표현할 수 있다
- 산술 표현식
  - ceil, floor, 자연로그, 로그를 계산할 수 있고, 사칙연산이 가능하다
  - 제곱근 계산처럼 더 복잡한 작업도 수행 가능하다
- 문자열 표현식
  - concat, substring, 대소문자 및 텍스트 검색과 관련된 작업을 수행할 수 있다
- 배열 표현식
  - 배열 요소를 필터링 하거나 배열을 분할하거나 특정 배열에서 값의 범위를 가져오는 등 배열을 조작하는데 유용하다
- 가변적 표현식
  - 리터럴, 날짜 값 구문 분석을 윟나 식, 조건식을 사용한다
- 누산기
  - 합계, 기술 통계 및 기타 여러 유형의 값을 계산하는 기능을 제공한다

## $project
