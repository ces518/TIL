# 2장 몽고DB 기본
- 몽고DB 의 데이터 기본 단위 = **도큐먼트**
- **컬렉션** 은 동적 스키마가 존재하는 테이블과 같음
- 몽고DB의 단일 인스턴스는 자체적인 컬렉션을 갖는 여러 개의 독립적인 데이터베이스를 호스팅함
- 모든 도큐먼트는 컬렉션 내에서 고유한 특수키인 _id 를 가짐
- 몽고DB 는 **몽고 셀** 이라는 도구와 함께 배포되며 이는 인스턴스 관리및 쿼리언어로 데이터 조직을 위한 내장 지원 제공

## 2.1 도큐먼트
- 몽고 DB 의 핵심 => 정렬도니 키와 연결된 값 집합으로 이루어진 **도큐먼트**
- 대부분의 언어는 도큐먼트를 자연스럽게 해석하는 자료구조를 가진다.

```text
{
    "greeting": "Hello, World!"
}
```
- 도큐먼트의 값은 blob 형이 아닌 데이터형 이어야 한다.
- 도큐먼트의 키는 문자열이며 다음 예외릴 제외하면 어떤 UTF-8 문자든지 사용할 수 있다.
  - 키는 null 문자 (\0) 를 포함하지 않으며, 키의 끝을 나타내는데 사용해야 한다.
  - .과 $는 특별한 속성을 가지며 이는 예약어로 사용된다.

## 2.2 컬렉션
- **컬렉션** = 도큐먼트의 모음
- 몽고 DB 의 도큐먼트 = RDB 의 행에 대응되며 컬렉션 은 테이블에 해당 된다.

### 2.2.1 동적 스키마
- 컬렉션은 동적 스키마를 가진다.
- 하나의 컬렉션 내 도큐먼트들이 모두 다른구조를 가질 수 있다.
- 다른 구조의 도큐먼트라도 같은 컬렉션에 저장 가능한데, 왜 별도 컬렉션이 필요한가 ? 에 대한 의문을 가질 수 있다.
  - 같은 컬렉션에 여러 종류의 도큐먼트 저장시 개발/관리자에게 번거로움
  - 쿼리한 코드가 다른 구조의 도큐먼트를 다룰수 없을 수 있다
  - 컬렋녀 별 목록을 뽑으면 한 컬렋녀 내 특정 데이터형 별 쿼리해 목록을 뽑을때 보다 훨씬 빠름
  - 같은 종류의 데이터를 하나에 모아두면 **데이터 지역성 (캐시)** 에도 좋다.
  - 인덱스를 만들면 도큐먼트는 특정 구조를 가져야한다.
  - 인덱스는 컬렉션 별로 정의한다.

### 2.2.2 네이밍
- 컬렉션은 이름으로 식별되며, 어떤 UTF-8 문자열이든 사용할 수 있지만 몇가지 제약이 있다.
  - 빈 문자열은 사용할 수 없다
  - null 문자는 컬렉션명으로 사용할 수 없다
  - system. 으로 시작한느 컬렉션은 시스템 컬렉션에서 사용하는 예역어기때문에 사용할 수 없다
  - 사용자가 만든 컬렉션에는 예약어인 $를 포함할 수 없다

#### 서브 컬렉션
- 서브 컬렉션의 네임스페이스에 .(마침표) 문자를 사용해 컬렋녀을 체계화 한다.
- 블로그 기능이 있는 애플리케이션이라면 blog.posts blogs.authors 라는 컬렉션을 가질 수 있다
- 이는 단지 체계화를 위함이며 blog 컬렉션이나 자식 컬렉션 과는 아무런 관계가 없다
- 서브 컬렉션은 특별한 속성이 없지만, 여러 몽고 툴에서 지원하므로 유용하다
  - 큰파일을 저장하는 GridFS 프로토콜은 콘텐츠 데이터와 별도로 메타데이터 저장시 서브컬렉션을 사용한다
  - 대부분 드라이버는 특정 컬렉션의 서브 컬렉션에 접근하는 편한 문법을 제공한다

> 서브 컬렉션은 몽고 DB 를 데이터를 체계화 하는 훌륭한 방법

## 2.3 데이터베이스
- 몽고 DB 는 컬렉션에 도큐먼트 그룹화뿐 아니라 데이터베이스에 컬렉션을 그룹 지어 놓는다.
- 몽고 DB 의 단일 인스턴스는 여러 데이터베이스를 호스팅할 수 있으며 각 데이터베이스를 완전히 독립적으로 취급할 수 있다
- 한 애플리케이션의 데이터를 동일한 데이터베이스에 저장하는 것은 좋은 방식이다
- 데이터베이스를 나누면 하나의 몽고 DB 에서 여러 애플리케이션이나 여러 사용자 데이터 저장시 유용하다
- 데이터베이스는 컬렉션과 동일하게 이름으로 식별되며 몇가지 제약조건이 있다
  - 빈 문자열은 유효하지 않다
  - 다음 문자를 포함할 수 없다다
    - /, \, . , ' ' , *, <, >, :, |, ?, $, null문자, 단일공간
  - 대소문자를 구분한다
  - 최대 64바이트 이다
- 특별한 의미론을 갖는 예약된 데이터베이스 명도 있다
  - admin
    - 인증/권한 부여와 관련된 역할
  - local
    - 단일 서버에 대한 데이터 저장
    - 레플리카셋에서 복제 프로세스에 사용된 데이터를 저장함
    - local 자체는 복제되지 않는다
  - config
    - 샤딩된 몽고 클러스터는 config 데이터베이스를 사용해 갹 샤드의 정보를 젖아한다

## 2.4 몽고DB 시작
- 설치 및 실행이므로 생략

## 2.5 몽고 DB 셸 소개

### 셸 실행

```shell
mongo
```
- mongo 를 실행해 셸을 싲가한다.
- 셸은 완전한 자바스크립트 해석기이며 임의의 자바스크립트 프로그램을 실행한다.
- 함수를 정의하고 호출도 가능하다.

### 몽고 DB 클라이언트
- 셸은 독자적으로 쓸 수 있는 몽고 DB 클라이언트이다
- 시작시 몽고 DB 서버의 test 데이터베이스에 연결하며, 데이터베이스 연결을 전역변수 db 에 할당한다.
- 셸에서 주로 이 변수로 db 에 접근한다

```shell
> db
test
```
- db 에 할당된 데이터베이스를 확인한다

```shell
> use video
switched to db video
```
- 데이터베이스를 선택한다

### 기본 작업
- 셸에서 데이터 조작시 생성, 읽기, 갱신, 삭제 네 가지 기본적인 동작을 지원한다

#### 생성
- insertOne 함수는 컬렉션에 도큐먼트를 추가할 수 있다.

```shell
> movie = { "title": "Start Wars" }
> db.movies.insertOne(movie)
{
  "acknowledged": true,
  "insertedId": ObjectId("519478dfsdfsdf")
}
```

#### 읽기
- find 와 findOne 은 컬렉션을 쿼리하는데 사용한다
- 단일 도큐먼트를 읽으려면 findOne 을 사용한다

```shell
> db.movies.findOne()
```
- find 와 findOne 은 쿼리 도큐먼트 형태로 조건을 전달할 수도 있다.
  - 이는 검색조건
- find 는 일치하는 도큐먼트를 20개 까지 자동 출력하지만 그 이상을 가져올 수도 있다.

#### 갱신
- 도큐먼트 갱신시 updateOne 을 사용한다.
- 이 함수의 매개변수는 최소 두 개이다
- 첫 인자는 수정할 도큐먼트를 찾는 기준이고, 두 번째는 갱신 작업을 설명하는 도큐먼트 이다.

```shell
> db.movies.updateOne({ title : "Start Wars"}, ... {$set: {reviews: []}})
WriteResult({"nMatched": 1, "nUpserted": 0, "nModified": 1})
```

#### 삭제
- deleteOne / deleteMany 는 도큐먼트를 데이터베이스에서 영구 삭제한다.
- 두 함수 모두 필터 도큐먼트로 삭제 조건을 짖어한다

```shell
> db.movies.deleteOne({ title : "Start Wars"});
```

## 2.6 데이터 형

### 기본 데이터 형

`null`
- null 과 존재하지 않는 필드를 표현하는 데 사용

`불리언`
- 참과 거짓 값에 사용

`숫자`
- 셸은 64비트 부동소수점 수를 기본으로 사용한다.
- 4바이트 혹은 8바이트 부호 정수는 NumberInt, NumberLong 클래스를 사용해야 한다

```shell
{ "x" : NumberInt("3") }
```

`문자열`
- 어떤 UTF-8 문자열이든 문자열형으로 표현 가능

`날짜`
- 1970년 1월 1일 부터 시간을 1/1000 초 단위로 표현하는 64비트 정수로 날짜를 저장한다
- TimeZone 은 저장하지 않는다

`정규 표현식`
- 자바스크립트의 정규 표현식 문법을 사용할 수 있다

`배열`
- 셋이나 리스트를 배열로 표현할 수 있다

`내장 도큐먼트`
- 도큐먼트는 부모 도큐먼트의 값으로 내장된 도큐먼트 전체를 포함할 수 있다

`객체 ID`
- 객체 ID 는 도큐먼트용 12바이트 ID

`이진 데이터`
- 임의의 바이트 문자열이며 셸에서 조작 불가
- UTF-8 이 아닌 문자열을 젖아하는 유일한 방법

`코드`
- 임의의 자바스크립트 코드를 포함할 수 있다

### 날짜
- 자바스크립트의 Date 클래스를 사용한다
- 새로운 Date 객체 생성시 new Date() 를 호출해야 함
- 셸에서는 날짜가 현지 시간대 설정을 이용해 표시된다
- 하지만 데이터베이스의 날짜는 1970년 1월 1일 부터 시간을 1/1000 초 단위로 저장하며 타임존 정보는 없다

### 배열
- 배열은 정렬 연산 (리스트, 스택, 큐) 과 비정렬 연산 (셋) 에 호환성 있게 사용 가능한 값이다.
- 배열은 서로 다른 데이터형을 값으로 포함할 수 있다.
- 심지어 중첩 배열도 될 수 있다.
- 배열에 쿼리하거나 배열의 내용을 이용해 인덱스를 만들 수 있다.

### 내장 도큐먼트
- 도큐먼트는 키에 대한 값이 될 수 있으며, 이를 내장 도큐먼트 라고 한다
- 이를 사용해 좀 더 자연스러운 방법으로 구성이 가능하다

```shell
{
  "name": "John Doe",
  "address": {
    "street" : "123 Park Street",
    "city" : "Anytown",
    "state" : "NY"
  }
}
```

### _id 와 ObjetId
- 몽고 DB 에 저장된 모든 도큐먼트는 _id 라는 키를 가진다.
- _id 는 어떤 데이터형이어도 상관없지만 기본적으로 ObjectId 이다
- 하나의 컬렉션에 모든 도큐먼트는 고유한 값을 갖는다.

`ObjectIds`
- ObjectId 는 _id 의 기본 데이터형이다.
- ObjectId 클래스는 가벼우면서 여러 장비에 걸쳐 전역적으로 고유하게 생성하기 쉽게 설계 되었다.
- 자동 증가 값을 사용하지 않는 주요 목적은 몽고 DB 의 분산 특성 때문이다
- 여러 서버에 걸쳐 자동증가 값을 기본 키로 동기화 하는 작업은 어렵고 시간이 걸린다
- 몽고 DB 는 분산 데이터베이스로 설계되었기에 샤딩된 환경에서 고유 식별자를 생성하는 것이 매우 중요하다
- ObjectId 는 12바이트 스토리지를 사용하며 24자리 16 진수 문자열 표현이 가능하다
  - 바이트당 2 자리 사용
- 거대한 16진수 문자열로 표현되지만 실제 문자열은 저장된 데이터의 두 배 만큼 길다
- 연속적으로 생성하게 되면 마지막 숫자 몇개만 바뀐다
- 몇 초간 격을 둔다면 중간 숫자 몇 개만 바뀐다

`ObjectId 의 생성 방식`

```shell
0 1 2 3 4 5 6 7 8 9 10 11
타임스탬프 랜덤    카운터 (랜덤 시작 값)
```
- 첫 4바이트는 1970년 1월 1일 부터의 시간을 1/1000 초 단위로 저장하는 타임 스탬프이다
  - 그 다음 5바이트와 묶일 때 초 단위의 유일성을 제공
  - ObjectId 를 효율적으로 인덱싱 가능
  - 도큐먼트 생성시의 타임스탬프가 존재한다.
- 서버 시각을 동기화할 필요는 없다
- 다음 5바이트는 랜덤 값
  - 최종 3 바이트는 서로 다른 시스템에서 충돌하지 않도록 랜덤 값으로 시작하는 카운터
- 앞 9 바이트는 1초 동안 여러 장비와 프로세스 에 걸쳐 유일성을 보장함
- 마지막 3바이트는 단순히 증분하는 숫자이며 1초 내 단일 프로세스의 유일성을 봊아한다

`_id 자동생성`
- 도큐먼트 생성시 _id 키를 명시하지 않으면 입력된 도큐먼트에 키가 자동으로 추가된다

## 몽고DB 셸 사용

### 셸 활용 팁
- help 를 입력하면 셸에 내장된 도움말 확인 가능
- db 수준의 도움말은 db.help() / 컬렉션 수준의 도움말은 db.{collection}.help()
- 함수 기능을 알고 싶다면 괄호 없이 입력하면 된다.

### .mongosrc.js 생성
- 자주 로드되는 스크립트 (셸 시작때 마다...) .mongosrc.js 파일에 넣을 수 있다

