# 2장 몽고DB 기본
- 몽고DB 의 데이터 기본 단위 = **도큐먼트**
- **컬렉션** 은 동적 스키마가 존재하는 테이블과 같음
- 몽고DB의 단일 인스턴스는 자체적인 컬렉션을 갖는 여러 개의 독립적인 데이터베이스를 호스팅함
- 모든 도큐먼트는 컬렉션 내에서 고유한 특수키인 _id 를 가짐
- 몽고DB 는 **몽고 셀** 이라는 도구와 함께 배포되며 이는 인스턴스 관리및 쿼리언어로 데이터 조직을 위한 내장 지원 제공

## 2.1 도큐먼트
- 몽고 DB 의 핵심 => 정렬도니 키와 연결된 값 집합으로 이루어진 **도큐먼트**
- 대부분의 언어는 도큐먼트를 자연스럽게 해석하는 자료구조를 가진다.

```text
{
    "greeting": "Hello, World!"
}
```
- 도큐먼트의 값은 blob 형이 아닌 데이터형 이어야 한다.
- 도큐먼트의 키는 문자열이며 다음 예외릴 제외하면 어떤 UTF-8 문자든지 사용할 수 있다.
  - 키는 null 문자 (\0) 를 포함하지 않으며, 키의 끝을 나타내는데 사용해야 한다.
  - .과 $는 특별한 속성을 가지며 이는 예약어로 사용된다.

## 2.2 컬렉션
- **컬렉션** = 도큐먼트의 모음
- 몽고 DB 의 도큐먼트 = RDB 의 행에 대응되며 컬렉션 은 테이블에 해당 된다.

### 2.2.1 동적 스키마
- 컬렉션은 동적 스키마를 가진다.
- 하나의 컬렉션 내 도큐먼트들이 모두 다른구조를 가질 수 있다.
- 다른 구조의 도큐먼트라도 같은 컬렉션에 저장 가능한데, 왜 별도 컬렉션이 필요한가 ? 에 대한 의문을 가질 수 있다.
  - 같은 컬렉션에 여러 종류의 도큐먼트 저장시 개발/관리자에게 번거로움
  - 쿼리한 코드가 다른 구조의 도큐먼트를 다룰수 없을 수 있다
  - 컬렋녀 별 목록을 뽑으면 한 컬렋녀 내 특정 데이터형 별 쿼리해 목록을 뽑을때 보다 훨씬 빠름
  - 같은 종류의 데이터를 하나에 모아두면 **데이터 지역성 (캐시)** 에도 좋다.
  - 인덱스를 만들면 도큐먼트는 특정 구조를 가져야한다.
  - 인덱스는 컬렉션 별로 정의한다.

### 2.2.2 네이밍
- 컬렉션은 이름으로 식별되며, 어떤 UTF-8 문자열이든 사용할 수 있지만 몇가지 제약이 있다.
  - 빈 문자열은 사용할 수 없다
  - null 문자는 컬렉션명으로 사용할 수 없다
  - system. 으로 시작한느 컬렉션은 시스템 컬렉션에서 사용하는 예역어기때문에 사용할 수 없다
  - 사용자가 만든 컬렉션에는 예약어인 $를 포함할 수 없다

#### 서브 컬렉션
- 서브 컬렉션의 네임스페이스에 .(마침표) 문자를 사용해 컬렋녀을 체계화 한다.
- 블로그 기능이 있는 애플리케이션이라면 blog.posts blogs.authors 라는 컬렉션을 가질 수 있다
- 이는 단지 체계화를 위함이며 blog 컬렉션이나 자식 컬렉션 과는 아무런 관계가 없다
- 서브 컬렉션은 특별한 속성이 없지만, 여러 몽고 툴에서 지원하므로 유용하다
  - 큰파일을 저장하는 GridFS 프로토콜은 콘텐츠 데이터와 별도로 메타데이터 저장시 서브컬렉션을 사용한다
  - 대부분 드라이버는 특정 컬렉션의 서브 컬렉션에 접근하는 편한 문법을 제공한다

> 서브 컬렉션은 몽고 DB 를 데이터를 체계화 하는 훌륭한 방법

## 2.3 데이터베이스
- 몽고 DB 는 컬렉션에 도큐먼트 그룹화뿐 아니라 데이터베이스에 컬렉션을 그룹 지어 놓는다.
- 몽고 DB 의 단일 인스턴스는 여러 데이터베이스를 호스팅할 수 있으며 각 데이터베이스를 완전히 독립적으로 취급할 수 있다
- 한 애플리케이션의 데이터를 동일한 데이터베이스에 저장하는 것은 좋은 방식이다
- 데이터베이스를 나누면 하나의 몽고 DB 에서 여러 애플리케이션이나 여러 사용자 데이터 저장시 유용하다
- 데이터베이스는 컬렉션과 동일하게 이름으로 식별되며 몇가지 제약조건이 있다
  - 빈 문자열은 유효하지 않다
  - 다음 문자를 포함할 수 없다다
    - /, \, . , ' ' , *, <, >, :, |, ?, $, null문자, 단일공간
  - 대소문자를 구분한다
  - 최대 64바이트 이다
- 특별한 의미론을 갖는 예약된 데이터베이스 명도 있다
  - admin
    - 인증/권한 부여와 관련된 역할
  - local
    - 단일 서버에 대한 데이터 저장
    - 레플리카셋에서 복제 프로세스에 사용된 데이터를 저장함
    - local 자체는 복제되지 않는다
  - config
    - 샤딩된 몽고 클러스터는 config 데이터베이스를 사용해 갹 샤드의 정보를 젖아한다

## 2.4 몽고DB 시작
- 설치 및 실행이므로 생략

## 2.5 몽고 DB 셸 소개

### 셸 실행

```shell
mongo
```
- mongo 를 실행해 셸을 싲가한다.
- 셸은 완전한 자바스크립트 해석기이며 임의의 자바스크립트 프로그램을 실행한다.
- 함수를 정의하고 호출도 가능하다.

### 몽고 DB 클라이언트
- 셸은 독자적으로 쓸 수 있는 몽고 DB 클라이언트이다
- 시작시 몽고 DB 서버의 test 데이터베이스에 연결하며, 데이터베이스 연결을 전역변수 db 에 할당한다.
- 셸에서 주로 이 변수로 db 에 접근한다

```shell
> db
test
```
- db 에 할당된 데이터베이스를 확인한다

```shell
> use video
switched to db video
```
- 데이터베이스를 선택한다

### 기본 작업
- 셸에서 데이터 조작시 생성, 읽기, 갱신, 삭제 네 가지 기본적인 동작을 지원한다

#### 생성
- insertOne 함수는 컬렉션에 도큐먼트를 추가할 수 있다.

```shell
> movie = { "title": "Start Wars" }
> db.movies.insertOne(movie)
{
  "acknowledged": true,
  "insertedId": ObjectId("519478dfsdfsdf")
}
```

#### 읽기
- find 와 findOne 은 컬렉션을 쿼리하는데 사용한다
- 단일 도큐먼트를 읽으려면 findOne 을 사용한다

```shell
> db.movies.findOne()
```
- find 와 findOne 은 쿼리 도큐먼트 형태로 조건을 전달할 수도 있다.
  - 이는 검색조건
- find 는 일치하는 도큐먼트를 20개 까지 자동 출력하지만 그 이상을 가져올 수도 있다.

#### 갱신
- 도큐먼트 갱신시 updateOne 을 사용한다.
- 이 함수의 매개변수는 최소 두 개이다
- 첫 인자는 수정할 도큐먼트를 찾는 기준이고, 두 번째는 갱신 작업을 설명하는 도큐먼트 이다.

```shell
> db.movies.updateOne({ title : "Start Wars"}, ... {$set: {reviews: []}})
WriteResult({"nMatched": 1, "nUpserted": 0, "nModified": 1})
```

#### 삭제
- deleteOne / deleteMany 는 도큐먼트를 데이터베이스에서 영구 삭제한다.
- 두 함수 모두 필터 도큐먼트로 삭제 조건을 짖어한다

```shell
> db.movies.deleteOne({ title : "Start Wars"});
```