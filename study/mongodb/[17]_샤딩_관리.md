# 17장 샤딩 관리
- 클러스터 상태 검사
- 클러스터 멤버 추가, 제거, 변경
- 데이터 이동 관리 및 데이터 수동 이동

## 현재 상태 확인
- 데이터의 위치, 샤드 구성, 클러스터 실핵 작업 조회가 가능한 몇 가지 보조자 함수 살펴보기

### sh.status()
- sh.status 함수는 샤드, 데이터베이스, 샤딩된 컬렉션의 개요를 제공한다
  - 청크 개수가 적은경우 => 어느 청크가 어디 위치하는지까지 출력
  - 청크 개수가 많은경우 => 컬렉션의 샤드 키와 각 샤드가 갖는 청크 개수 보고 (청크 상태 요약)

> 모든 청크를 보기 원하는 경우 => sh.status(true) 실행

### 구성 정보 확인하기
- 클러스터에 대한 모든 구성 정보는 구성 서버의 config 데이터베이스 내 컬렉션에 보관된다
  - 셸 보조자를 사용해 더 읽기 쉽게 볼 수 있음
  - 클러스터에 대한 메타데이터 조회시 config 데이터베이스에 직접 쿼리할 수 있음
- config 데이터베이스에는 몇 가지 컬렉션이 있으며, 각 컬렉션이 무엇을 포함하며 어떻게 사용되는지 살펴본다

`config.shards`
- shards 컬렉션은 클러스터 내 모든 샤드를 추적하며 shards 컬렉션 내 들어 있는 도큐먼트는 다음과 같이 보인다

```shell
db.shards.find()
{
  "_id" : "shard01",
  "host" : "shard01/localhost:27018,localhost:27019,localhost:27020",
  "state" : 1
},
{
  "_id" : "shard02",
  "host" : "shard02/localhost:27021,localhost:27022,localhost:27023",
  "state" : 1
}
```
- 샤드의 _id 는 복제 셋의 이름에서 가져오기 때문에 클러스터 안에 있는 각 복제 셋의 이름은 고유해야 한다
- 복제 셋 구성을 변경하면 "host" 필드는 자동으로 변경된다

`config.databases`
- databases 컬렉션은 클러스터가 알고 있는 모든 샤딩 및 비샤딩 데이터베이스를 추적한다

```shell
db.databases.find()
{
  "_id" : "video", "primary" : "shard02", "partitioned" : true,
  "version" : {"uuid" : UUID("345141-23fdsfdsf-424-.."), "lastMod" : 1}
}
```
- enableSharding 데이터베이스에서 실행된 적이 있으면 partitioned : true 가 된다
- primary => 데이터베이스의 홈 베이스
- 기본적으로 데이터베이스 내 새로운 컬렉션은 모두 데이터베이스의 프라이머리 샤드에 생성된다

`config.collections`
- collections 컬렉션은 모든 샤딩된 컬렉션을 추적한다 (샤딩되지 않은 컬렉션은 보이지 않음)

```shell
db.collections.find().pretty()
{
  "_id" : "config.system.sessions",
  "lastmodEpoch" : ObjectId("5fsdfds0123sdd"),
  "lastmod" : ISODate("1970-02-19T17:02:47.269Z"),
  "dropped" : false,
  "key" : {
    "_id" : 1
  },
  "unique" : false,
  "uuid" : UUID("7584e414-facads-4124214-dasdsad")
}
```
- 중요 필드는 다음과 같다
  - _id
    - 컬렉션의 네임스페이스
  - key
    - 샤드키
  - unique
    - 샤드 키가 고유한 인덱스는 아님을 나타냄.
    - 기본적으로 샤드 키는 고유하지 않다

`config.chunks`
- chunks 컬렉션은 모든 컬렉션 내 모든 청크의 기록을 보관한다

```shell
db.chunks.find().skip(1).limit(1).pretty()
{
  "_id" : "video.movies-imdbId_Minkey",
  "lastmod" : Timestamp(2, 0),
  "lastmodEpoch" : ObjectId("5dbfdf72cccsdkfdfd"),
  "ns" : "video.movies",
  "min" : {
    "imdbId" : {"$minKey" : 1}
  },
  "max" : {
    "imdbId" : NumberLong("-4281490182490823")
  },
  "shard" : "shard01",
  "history" : [
    {
      "validAfter" : Timestamp(154137052352,3096),
      "shard" : "shard01"
    }
  ]
}
```
- 중요 필드는 다음과 같다
  - _id
    - 청크 고유 식별자
    - 일반적으로 네임스페이스, 샤드 키 하위 청크 범위이다
  - ns
    - 청크가 위치한 컬렉션
  - min
    - 청크 범위 내 최솟값
  - max
    - 청크 내 모든 값은 이 값보다 작다
  - shard
    - 청크가 위치하는 샤드
  - lastmod
    - 청크 버전 관리를 추적한다
- sh.status() => config.chunks 컬렉션을 사용해 대부분의 정보를 수집한다

`config.changelog`
- changelog 컬렉션은 발생한 분할과 마이그레이션을 모두 기록하므로 클러스터가 무엇을 하고 있는지 추적하는데 유용하다

```shell
db.changelog.find({what: "split"}).pretty()
{
  "_id" : "router1-2018-11-5325325...",
  "server" : "bob",
  "clientAddr" : "127.0.0.1:64621",
  "time" : ISODate("2018-11-05T14:58:58.915Z"),
  "what" : "split",
  "ns" : "video.movies",
  "details": {
    "before" : {
      "min" : {
        "imdbId" : NumberLong("124812940184")
      },
      "max" : {
        "imdbId" : NumberLong("184091284901284")
      },
      "lastmod" : Timestamp(9, 1),
      "lastmodEpoch" : ObjectId("fjkdskjfl134901249")
    },
    "left" : {
      "min" : {
        "imdbId" : NumberLong("124812940184")
      },
      "max" : {
        "imdbId" : NumberLong("184091284901284")
      },
      "lastmod" : Timestamp(9, 1),
      "lastmodEpoch" : ObjectId("fjkdskjfl134901249")
    },
    "right" : {
      "min" : {
        "imdbId" : NumberLong("124812940184")
      },
      "max" : {
        "imdbId" : NumberLong("184091284901284")
      },
      "lastmod" : Timestamp(9, 1),
      "lastmodEpoch" : ObjectId("fjkdskjfl134901249")
    }
  }
}
```
- details => 원본 도큐먼트가 어떻게 생겼으며 무엇으로 분활됐는지 알려준다

`config.settings`
- 현재의 밸런서 설정과 청크 크기를 나타내는 도큐먼트를 포함한다
- 컬렉션 내 도큐먼트를 변경해 밸런서를 켜고 끄거나 청크 크기를 변경할 수 있다
- 컬렉션 내 값을 변경할 때 구성 서버에 직접 연결하지 말고 항상 mongos 에 연결해야 함을 명심하자

## 네트워크 연결 추적
- 클러스터의 구성 요소들 사이에는 수많은 연결이 있다
- 샤딩에 특화된 정보를 다룬다.

### 연결 통계 정보 얻어오기
- connPoolStats 명령은 현재 데이터베이스 인스턴스에서 샤드 클러스터나 복제 셋의 다른 멤버로 나가는 열린 연결에 대한 정보를 반환한다
- connPoolStats는 실행 중인 작업과 간섭을 피하려고 락을 사용하지 않는다
- 따라서 connPoolStats 가 정보를 수집할 때 개수가 약간 바뀌어, 호스트와 풀 연결 개수 간에 약간의 차이가 생길 수 있다

```shell
db.adminCommand({"connPoolStats" : 1})
```

### 연결 개수 제한하기
- 클라이언트가 mongos 에 접속하면 mongos 는 클라이언트의 요청을 전달하려고 최소 하나의 샤드에 연결을 생성한다
- 따라서 mongos 에 들어온 각 클라이언트 연결은 mongos 에서 샤드로 나가는 연결을 적어도 한 개는 만든다
- mongos 프로세스가 여러 개이면 샤드가 다룰수 있는 양보다 더 많은 연결을 생성할 수 있다
- 기본적으로 65,536 개 연결을 허용하며, 각 1만개의 연결을 갖는 5개의 mongos 프로세스가 있다면 하나의 샤드에 5만개 연결 생성을 시도한다
- 이를 방지하려면 mongos 명령행 구성에서 --maxConns 옵션을 사용해 생성 가능한 연결 개수를 제한해야 한다
- 아래 공식은 하나의 mongos 에서 샤드가 다룰 수 있는 연결의 최대 수를 계산하는데 사용한다
  - maxConns = maxConnsPrimary - (numMembersPerRelicaSet X 3)
  - (other X 3) / numMongosProcesses