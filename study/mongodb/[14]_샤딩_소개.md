# 14장 샤딩 소개
- 샤딩과 클러스터 구성 요소 소개
- 샤딩 구성 방법
- 샤딩과 애플리케이션의 상호작용 기본

## 샤딩이란
- 샤딩 => 여러 장비에 걸쳐 데이터를 분할하는 과정. 때로 **파티셔닝** 이라고도 한다
  - 더 많은 데이터를 저장하고, 더 많은 부하를 처리하기 위한 기법
- 하지만 샤딩은 다른 용도로도 사용한다
  - 더 자주 접근하는 데이터를 성능이 좋은 하드웨어에 배치, 지역에 따라 데이터셋을 분할하 주로 접근하는 서버와 가까운 컬렉션에서 도큐먼트와 서브셋을 찾게끔..
- 수동 샤딩 => 어떤 데이터베이스 소프트웨어를 사용하든 대부분 수행할 수 있다
  - 애플리케이션이 여러 데이터베이스 서버와 연결을 유지하고, 각 서버는 완전히 독립적이다
  - 애플리케이션은 각 다른 데이터를 다른 서버에 저장하고, 데이터를 가져오기 위해 적절한 서버에 쿼리하는 과정을 관리하게 된다
- 클러스터에 노드를 추가하거나, 데이ㅓ 분산 부하 패턴이 변경할 경우 유지하기가 힘들다
- 몽고 DB 는 애플리케이션에서 구조를 추상화하고, 시슽메 관리를 간단하게 하는 자동 샤등을 지원한다
- 운영 측면에서 몽고 DB 가 샤드에 걸쳐 데이터를 분산을 자동화 하기때문에 용량 추가/제거가 쉬움
- 개발 및 운영 측면에서 샤딩은 몽고 DB 를 구성하는 가장 어렵고 복잡한 방법이다
- 구성 및 모니터링 요소가 많고, 클러스터에서 자동으로 데이터가 옮겨다니기 때문이다

### 클러스터 구성 요소 이해하기
- 샤딩을 통해 많은 장비의 클러스터를 생성하고, 각 샤드에 데이터 서브셋을 넣음으로 인해 컬렉션을 쪼갤 수 있음
- 샤딩의 목적 => 2개, 3개, 1000개의 클러스터가 하나으 ㅣ장비처럼 보이게 하는 것
- 이런 세부사항을 애플리케이션으로 부터 숨기기 위해 샤드 앞단에 mongos 라는 라우팅 프로세스를 실행함
- mongos => 어떤 샤드가 어떤 데이터를 가지고 있는지 알려주는컨텐츠 목차가 있음

## 단일 장비 클러스터에서의 샤딩

```shell
mongo --nodb --nosrc

st = SharingTest({
  name : "one-min-shards",
  chunkSize : 1,
  shards : 2,
  rs : {
    nodes : 3,
    oplogSize : 10
  },
  other : {
    enableBalancer : true
  }
})
```
- ShardingTest 는 몽고 DB 엔지니어링 내부 용으로 설계된 클래스이다
- 외부적으로 문서화되지 않았으며, 샤드 클러스터를 실험하는 가장 ㄱ낟나한 수단
- 이는 원래 서버 테스트 셋을 지원하도록 설계되었으며, 이런 용도로 사용된다
  - ShardingTest => /data/db 디렉터리가 있다고 가정해 동작함
- 명령 실행시 수많은 작업을 수행한다
  - 두 개의 샤드가 있는 클러스터를 생성
  - 복제 셋을 구성하고 각 노드를 실행
  - mongos 를 시작해 전체 샤드 요청 관리
  - 구성 서버에 대한 추가 복제셋 시작 (쿼리를 올바른 샤드로 전달하는데 필요한 라우팅 테이블 정보 유지)
- ShardingTest 가 클러스터 설정을 마치면 연결가능한 프로세스는 10개 이다
  - 노드 3개로 구성된 복제셋 2개, 노드 3개로 구성된 구성서버 복제셋 1개 mongos 1개
- 기본적으로 포트 20000 에서 시작해야함 (mongos 는 20009)
- sh.status() 를 실행해 클러스터를 전체적으로 볼 수 있다
  - 샤드, 데이터베이스, 컬렉션에 대한 요약을 제공한다

`특정 컬렉션 샤딩하기`
- 먼저 컬렉션 데이터베이스에서 샤딩을 활성화 해야한다

```shell
sh.enableSharding("accounts")
```
- 컬렉션을 샤딩할 때 샤드 키를 선택하는데, 몽고 DB 가 데이터를 분할하는데 사용한다
- 인덱싱과 유사한 개념이며, 컬렉션이 커질수록 샤드 키가 컬렉션에서 가장 중요한 인덱스가 된다
- 샤드 키를 생성하려면 먼저 필드에 인덱스를 생성해야 한다
```shell
db.users.createIndex({"username" : 1})
sh.shardCollection("accounts.users", {"username" : 1})
```
- 실제 시스템에서 샤드 키를 선택할 때는 매우 신중하게 결정해야 한다

`샤딩의 단위, 청크`
- 샤딩 전 컬렉션의 기본 단위는 단일 청크이다
- 샤딩은 샤드 키를 기반으로 컬렋녀을 더 작은 청크로 분할하며, 분할된 청크는 여러 클러스터에 분산된다
- 청크 리스트 시작 끝에 있는 $minKey, $maxKey 를 확인하자
  - minKey : 음의 무한대
  - maxKey : 양의 무한대
- 샤드 키의 값은 항상 minKey ~ maxKey 사이에 있다
- 이런 값은 BSON 유형이고 애플리케이션에서 사용해서는 안되며 주로 내부용이다


- 일반적으로 쿼리에서 샤드 키를 사용하지 않으면 mongos 는 모든 샤드에 쿼리를 보내야 한다
- 샤드 키를 포함하며 단일 샤드나 샤드 서브셋으로 보낼 수 있는 쿼리 => 타겟 쿼리
- 모든 샤드로 보내야 하는 쿼리 => 분산-수집 쿼리라 한다
- mongos 는 쿼리를 모든 샤드로 분산한 뒤 결과를 수집한다