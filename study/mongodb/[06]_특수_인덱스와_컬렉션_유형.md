# 6장 특수 인덱스와 컬렉션 유형
- 큐 같은 데이터를 위한 제한 컬렉션
- 캐시를 위한 TTL 인덱스
- 단순 문자열 검색을 위한 전문 인덱스
- 2D 구현 및 구면 기하학을 위한 공간 정보 인덱스
- 대용량 파일 저장을 위한 GridFS

## 공간 정보 인덱스
- 몽고 DB 가 가지는 공간 정보 인덱스
  - 2dsphere
    - WGS84 좌표계 기반으로 지표면을 모델링하는 구면 기하학으로 작동
      - WGS84 는 지표면을 주상절벽으로 모델링한다
      - 극 지방에 약간의 평탄화가 존재함
    - 지구의 형태를 고려하기 때문에 2d 인덱스보다 정확한 거리 계산기 가능하다
  - 2d
    - 2차원평면의 점에 사용하는 것이 좋음
- 2dsphere 는 GeoJSON 형식으로 점, 선, 다각형의 기하 구조를 지정할 수 있다

```json
// 점 = 위도와 경도 좌표를 갖는 요소로 표현된다
{
  "name" : "New York City",
  "loc" : {
    "type" : "Point",
    "coordinates" : [50 , 2]
  }
}

// 선은 점의 배열로 표현된다
{
  "name" : "Hudson River",
  "loc" : {
    "type" : "LineString",
    "coordinates" : [[0,1], [0,2], 1,2]
  }
}

// 다각형은 선과 같은 방식으로 표현되지만 type 이 다르다
{
  "name" : "New England",
  "loc" : {
    "type" : "Polygon",
    "coordinates" : [[[0,1], [0,2], [1,2], [0,1]]]
  }
}
```

```shell
// createIndex 명령으로 공간 정보 인덱스를 만들 수 있다
db.openStreetMap.createIndex({"loc" : "2dsphere"})
```
- 2dsphere 인덱스를 만들려면 인덱싱할 도형이 포함된 필드 (loc) 를 지정하는 도큐먼트를 createIndex 에 전달해야 한다

### 공간 정보 쿼리 유형
- 공간 정보 쿼리 = 교차, 포함, 근접 세 가지 유형이 있다
- 찾을 항목을 GeoJSON 형태로 저장한다
- $geoIntersects : 쿼리 위치와 교차하는 도큐먼트를 찾을 수 있다
- $geoWithin : 특정 지역에 완전히 포함된 항목을 쿼리할 수 있다
- $near : 주변 위치에 쿼리할 수 있다
  - 이는 유일하게 정렬을 포함하는 공간 정보 연산자 이다
  - 결과는 항상 가까운곳 부터 먼곳 순으로 반환된다

```shell
db.openStreetMap.find(
  {"loc" : {"$geoIntersects" : {"$geometry" : eastVillage}}}
);
  
db.openStreetMap.find({"loc" : {"$geoWithin" : {"$geometry" : eastVillage}}};

db.openStreetMap.find({"loc" : {"near" : {"$geometry" : eastVillage}}};
```

### 공간 정보 인덱스 사용
- 몽고 DB 공간 정보 인덱스를 활용하면 특정 지역과 관련된 모양과 점이 포함된 컬렉션에서 공간 쿼리를 효율적으로 실행할 수 있다
- 사용자가 뉴욕에서 레스토랑을 찾도록 돕는 애플리케이션을 설계한다고 하면, 다음을 충족해야 한다
  - 사용자가 현재 위치한 지역 찾기
  - 해당 지역 내 레스토랑 수 보여주기
  - 지정된 거리 내에 있는 레스토랑 찾기
- 구면 기하학 데이터 쿼리시 2dsphere 인덱스를 사용한다

`쿼리에서의 2D vs 구면 기하학`
- 공간 정보 쿼리는 쿼리와 사용중인 인덱스 유형에 따라 구면 또는 평면 구조를 사용한다
- 다음은 각 공간 정보 연산자가 사용하는 기하 구조 유형이다

| 쿼리 유형                                    | 기하 구조 유형 |
|------------------------------------------|----------|
| $near (GeoJSON point, 2sphere 인덱스)       | 구면       |
| $near (레거시 좌표 2d 인덱스)                    | 평면       |
| $geoNear (GeoJSON point, 2sphere 인덱스)    | 구면       |
| $geoNear (레거시 좌표 2d 인덱스)                 | 평면       |
| $nearSphere (GeoJSON point, 2sphere 인덱스) | 구면       |
| $nearSphere (레거시 좌표 2d 인덱스)              | 구면       |
| geoWithin : {$geometry : ...}            | 구면       |
| geoWithin : {$box : ...}                 | 평면       |
| geoWithin : {$polygon : ...}             | 평면       |
| geoWithin : {$center : ...}              | 평면       |
| geoWithin : {$centerSphere : ...}        | 구면       |
| $geoIntersects                           | 구면       |

- 2d 인덱스는 구 (sphere) 에서 평면 기하학과 거리 계산을 모두 지원한다
- 하지만 구면 기하학을 사용하는 쿼리는 2dsphere 인덱스를 사용할 때 성능과 정확성이 향상됨
- $geoNear : 집계 연산자 라는 점에 유의
- $near 쿼리 연산 외에 $geoNear / geoNear 로 주변위치 쿼리가 가능함
  - $near 연산자는 **샤딩 된 컬렉션에서는 동작하지 않는다.**
- 집계 연산자는 2dsphere / 2d 인덱스가 컬렉션에 최대 1개만 존재해야 함
- $near $geoWithin 같은 공간 정보 쿼리 연산자는 여러 인덱스를 허용한다

`왜곡`
- 구면 기하는 지도에 시각화하면 왜곡이 있음
  - 지구와 같은 3차원 구를 평면에 투사하는 특성 때문

### 복합 공간 정보 인덱스
- 공간 정보 인덱스는 다른 인덱스와 마찬가지로 다른 필드와 묶음으로 인해 더 복잡한 쿼리 최적화가 가능하다

```shell
db.openStreet.createIndex({"tags" : 1, "location" : "2dsphere"})
```

### 2d 인덱스
- 비구체 지도 에는 2d 인덱스를 사용한다

```shell
db.hyrule.createIndex({"tile" : "2d"})
```
- 2d 인덱스는 지형이 구체가 아닌 완전한 평면이라고 가정한다
- 극 주변은 왜곡이 매우 심하므로 구체에 2d 인덱스를 사용해서는 안된다
- GeoJSON 데이터 저장시에는 2d 인덱스를 사용하지 않아야 함
  - 2d 인덱스는 점만 인덱싱 할 수 있다
    - 점 배열 저장이 가능하지만 정확하게는 선이 아닌 점의 배열을 저장한다.
- $geoWithin 쿼리에서 큰 차이가 있다
  - 점들로 이루어진 선은 도형에 완전히 포함되지 않는다.
