# 8장 트랜잭션
- 트랜잭션은 무엇인가
- 트랜잭션을 사용하는 방법
- 애플리케이션을 위한 트랜잭션 제한 조정

## 트랜잭션 소개
- 트랜잭션은 읽기나 쓰기 작업이 가능한 데이터베이스 작업을 하나 이상 포함하는 데이터베이스의 **논리적 처리 단위**
- 트랜잭션의 중요한 특징 => 작업이 성공하든 실패하든 부분적으로는 완료되지 않는다

> 트랜잭션을 사용하려면 몽고 4.2 이상이어야 하며 몽고 DB 드라이버도 갱신해야 한다

### ACID 의 정의
- ACID => 원자성, 일관성, 고립성, 영속성의 약자
- ACID 트랜잭션은 정전 등 오류가 발생해도 데이터와 데이터베이스 상태의 유효성을 보장한다

`원자성`
- 트랜잭션 내 모든 작업이 적용되거나 아무 작업도 적용되지 않도록 한다
- 트랜잭션은 부분적으로 적용될 수 없다.
- 커밋되거나 중단된다

`일관성`
- 트랜잭션이 성공하면 데이터베이스가 하나의 일관성이 있는 상태로 이동하도록 한다

`고립성`
- 여러 트랜잭션이 데이터베이스에서 동시에 실행되도록 허용한다
- 트랜잭션이 다른 트랜잭션의 부분 결과를 보지 않도록 보장한다
- 여러 병렬 트랜잭션이 각 트랜잭션을 순차적으로 실행할 때와 동일한 결과를 얻게 된다

`영속성`
- 트랜잭션이 커밋될 때 시스템 오류가 발생하더라도 모든 데이터가 유지되도록 한다

> 데이터베이스는 이런 속성을 모두 충족하고 성공적인 트랜잭션만 처리될 떄 ACID 를 준수한다고 한다.

## 트랜잭션 사용법
- 몽고 DB 는 트랜잭션 사용을 위한 두 가지 API 를 제공한다
  - 코어 API : 관계형 데이터베이스와 유사한 구문
  - 콜백 API : 트랜잭션 사용에 권장되는 접근 방식
- 코어 API 는 대부분 오류에 재시도 로직을 제공하지 않아, 개발자가 해당 로직을 모두 작성해야 함
- 콜백 API 는 지정된 논리 세션과 관련된 트랜잭션 시작, 콜백 함수로 제공된 함수 실행, 트랜잭션 커밋 을 포함해 많은 기능을 래핑하는 단일 함수를 제공한다
  - 커밋 오류를 처리하는 재시도 로직도 포함
- 콜백 API 는 4.2 에 추가되어 트랜잭션을 사용한 개발을 단순화 한다

`코어 API 콜백 API 비교`

| 코어 API | 콜백 API |
| --- | --- |
| 트랜잭션 시작/커밋시 명시적인 호출 필요 | 트랜잭션 시작하고 지정된 작업를 실행 후 커밋한다 |
| TransientTransactionError 및 UnknownTransactionCommitResult 에 대한 오류 처리 로직을 통합하지 않고, 사용자 지정 오류 처리를 통합하는 유연성 제공 | TransientTransactionError 및 UnknownTransactionCommitResult 에 대한 오류 처리 로직을 통합 |
| 특정 트랜잭션을 위하 API 로 전달되는 명시적 논리 세션이 필요함 | 특정 트랜잭션을 위해 API 로 전달되는 명시적 논리 세션이 필요함 |

## 애플리케이션을 위한 트랜잭션 제한 조정
- 트랜잭션을 사용할 때 알아야할 몇 가지 매개변수를 살펴본다

### 타이밍과 Oplog 크기 제한
- 몽고 DB 트랜잭션은 두 가지 주요 제한 범주가 있다
- 1. 트랜잭션의 시간 제한
- 2. 몽고 DB oplog 항목과 개별 ㅎ아목의 크기 제한

`시간 제한`
- 트랜잭션 최대 실행 시간은 기본적으로 1분 이하
- mongod 인스턴스 레벨에서 `transactionLifetimeLimitSeconds` 에 의해 제어되는 값을 수정할 수 있음
- 샤드 클러스터라면, 모든 레플리카 셋이 매개변수를 설정해야 한다
- 이 시간이 경과하면, 트랜잭션이 만료됬다고 간주하며 주기적으로 실행되는 정리 프로시스에 의해 중단된다
- 정리 프로세스는 60초 or `transactionLifetimeLimitSeconds` / 2 중 더 낮은 값을 주기로 실행된다
- 시간 제한을 명시적으로 설정하려면 `commitTransaction` 에 `maxTimeMS` 를 지정하는 것이 더 좋다
  - 지정하지 않을 경우 `transactionLifetimeLimitSeconds` 가 사용되며, transactionLifetimeLimitSeconds 를 초과하는 경우 transactionLifetimeLimitSeconds 가 사용됨
- 트랜잭션 작업시 필요한 락을 획득하는데 대기시간은 최대 5밀리초이다
  - `maxTransactionLockRequestTimeoutMills` 에 의해 제어되 수정이 가능하다
  - 0, -1 또는 0 보다 큰 숫자로 설정할 수 있따
- 0으로 설정한 경우 필요한 모든 락을 즉시 획득할 수 없다면 트랜잭션이 중단되며, -1 이라면 작업별 제한 시간이 `maxTimeMS` 에 지정된 대로 사용된다

`Oplog 크기 제한`
- 몽고 DB 는 트랜잭션의 쓰기 작업에 필요한 만큼 oplog 항목을 생성한다
- 각 oplog 는 BSON 도큐먼트 크기 제한인 16 메가 이하여야 한다 
