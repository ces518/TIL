# 이벤트 기반 분산 시스템을 향한 여정
- 배민찬 백엔드 시스템 (SCM) 을 이벤트 기반으로 ...
  
## 서비스
- 독립적으로 실행가능한 애플리케이션은 서비스라고 한다.
- 1개 이상의 서비스와 공유 인프라로 협업하는 구조

## 시스템 통합
- 시스템 통합을 위한 어댑터 서비스 구축
    - 레거시와 신규 시스템과 통합
- 메세징 기반으로 비동기 처리, 시스템간 결합도 제거
- 수신된 메세지에 대해 멱등성을 보장해야한다.

## 응집력 있는 도메인을 개념을 묶기
- layer 별로 모듈을 나누지 말고, 도메인 경계에 따라 패키지를 나눠야한다.
- 추후에 모듈로 뜯어낼 수 있을 정도의 수준으로 구분해야 한다.

> MSA 로 잘라내기 이전에 모듈화를 먼저 진행했음

## 왜 모듈화 인가 ?
- 모듈간의 상호작용은 내부 프로세스로 처리
- 단일 트랜잭션 관리로 인해 강력한 일관성 확보
- 섣불리 MSA 로 잘라냈다가 추후 시스템 통합시 고생하는 걸 방지

## 또 다른 모놀리식 시스템화 현상
- 각 서비스가 서로를 너무 잘 알고 있다.
- 너무 강한 결합도...
- 강결합을 깨고, 상호간의 의존관계를 단순화 해야한다.

> 이벤트 기반의 아키텍쳐를 이용해 결합도를 낮춰야 한다.

## 이벤트 생산과 소비를 통한 느슨한 결합
- 이벤트는 의미가 많다.
- 엔진엑스, 노드도 이벤트 기반 아키텍쳐..
- 시스템 간의 통합을 이벤트 기반 아키텍쳐..
- 이벤트 생산자 / 소비자 / 채널 3가지가 구성된다.
    - 생산자는 이벤트를 발행하기만 하면 된다.
    - 소비자는 이벤트 발행자를 알 필요가 없다.
        - 관심 있는 이벤트를 소비하기만 하면 된다.
    - 채널은 생산자 <-> 소비자 간의 통로

## 스프링 애플리케이션 이벤트 매커니즘
- ApplicationEventPublisher
    - 이벤트를 발행할 수 있음
    - ApplicationContext 가 이를 구현하고 있음.
    - 이벤트 채널로서의 역할을 수행한다.
- EventListener 등 인터페이스를 구현해야함.
- Spring 4.2 이후부터 @EventListener 를 이용해 특정 이벤트를 수신할 수 있음

## 도메인 이벤트 기반으로 통합되는 모듈
- 모듈간의 결합도가 제거되고, 의존성도 단순해진다.

## 원격 시스템의 등장, 통합을 위한 숙제
- 분산된 시스템, 분산될 모듈 들을 고려해서 아키텍쳐를 정리해야한다.
- 분산된 모놀리틱 시스템 이 되는걸 막아야한다.

## 시스템 혹은 서비스 통합을 위한 세가지 방법
- RESTful API
    - 웹이 가진 확장성과 신뢰성을 그대로 이어받음
    - 장애가 전파되지 않도록 적절한 방법이 필요
    - 트랜잭션에 대한 고민 필요
- Messaging
    - 안정적이고 확장성이 좋음
    - 비동기 메세지 전달을 통한 방법
    - 이벤트 기반 아키텍쳐와 유사한 장점
- Remote Procedure Call
    - 간단하지만, 시스템간의 결합도가 높아진다.
    
## 컨텍스트 간 협업을 위한 방식
- 동기 방식
    - 요청/응답
- 비동기 방식
    - 이벤트 기반

## 메세징과 RESTful API 를 적용한 시스템 아키텍쳐
- 비동기과 동기가 적절한 부분에 적용..
- 한가지 방식이 정답은 아니다. (은탄환은 없다.)

## 메세징 시스템은 어떤것 사용할 것인가 ?
- 최소한의 운영 비용
- 메세지 전달 신뢰성
- 단일 메세지가 여러 소비자에게 전달될 수 있는가
- 수평 확장성
- 러닝 커브
- 모니터링

> RabbitMQ, Kafka 등..

- AWS SQS
    - 점대점 방식으로 동작한다..
- Amazon SNS
    - 모든 소비자에 대해 보장하지 못함
- Amazon Kinesis
    - 샤드를 통해 무제한 확장은 가능하지만.. 자동화된 확장이 아닌 수동 제어가 필요하다
    - 러닝커브도 높다.
- Amazon MQ
    - ActiveMQ 기반으로 개발됨

> Amazon SNS 와 Amazon SQS 를 조합해서 사용한다.

- Amazon SNS 에 메세지를 발행하고, SNS 는 여러 SQS 에 발행해주는 방식을 채용
    - 차선책

## Spring Message
- Spring Cloud AWS 기반 메세지 발행/수신
    - @SqsListener (하나의 큐에 하나의 메세지만 가능)
- Spring Cloud Stream (AWS 지원하지 않음)
    - 이벤트 기반 아키텍쳐에서 많이 밀고 있는 추세
    
## 이벤트 기반 아키텍쳐와 메세징 아키텍쳐
- 이 둘이 적절히 통합되기를 원함
- 메세징 어댑터가 필요하다.

> 서비스, 모듈 간의 통합을 이벤트와 메세징 기반으로 통합