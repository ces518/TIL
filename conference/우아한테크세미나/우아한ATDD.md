# 우아한 ATDD

## 새로운팀, 새로운 개발 문화
- 페어 프로그래밍
  - 빠른 피드백
- 테스트 작성 권장
  - 테스트 코드로 부터 받는 피드백
  - 심리적 안정감
- **인수 테스트**
  - **시나리오 기반** 기능 테스트

### 인수 테스트의 도움
- 배포 없이 빠른 피드백
- 도메인과 서비스 흐름 파악에 도움이 됨

### without 인수 테스트
- 배포를 해야 피드백을 받을 수 있다
- 수동으로 변경사항을 확인해야함

### with 인수 테스트
- 배포 없이 테스트로 대부분 검증이 가능
- 인수 테스트로 스펙 표현 가능

### 피드백을 받는 방법
- 페어 프로그래밍
- 테스트 / 인수 테스트
- 코드 리뷰
- 배포
- 출시

### 테스트 주도 개발
- 테스트를 설계 활동으로 바꾸는 효과
- 설계 품질에 관한 피드백도 빠름

### 인수 테스트 장점
- 기존 ATDD 장점을 가진다.
- 인수 테스트 작성하며 구현 대상에 대한 이해도 증진

## ATDD란 ?

### 테스트 vs TDD
- 테스트
  - 검증의 용도
- TDD
  - 요구사항을 명세하는 용도

### TDD vs DDD
- TDD
  - 요구 사항을 명세하는 용도
- BDD
  - 요구 사항을 행위화
  - TDD 를 더 잘 설명하기 위해 나온 개념

> ATDD 는 **린 애자일** 과 관련됨

### ATDD 개발 프로세스
- 기능 : 강의 수강 대기 신청
- 인수 조건이 충복해야 하는 조건
  - 시나리오 기반으로 표현을 한다.

`given`
- 강사는 강의를 생성 했다
- 강사는 강의를 신청 가능 상태로 변경했다
- 강의 모집인원 만큼 신청을 받았다

`when`
- 회원이 수강 대기 신청을 요청한다

`then`
- 회원은 강의의 수강 대기자로 등록 되었다

> 인수 테스트를 충족하기 위한 코드 구현
> 기능 구현은 TDD 로 진행할 수 있다.

### 인수 조건 작성
- 검증 하고자 하는것 when 구문을 먼저 작성
- 기대 결과를 의미하는 then 구문 작성
- when 과 then 에서 필요한 정보를 given 을 통해 마련

### 인수 조건 예시
`given`
- 수강생이 수강 신청을 하였다.
- 과정의 남은 기간이 절반 이상이다.

`when`
- 강사는 특정 수강생의 수강 상태를 취소 요청을 한다.

`then`
- 특정 수강생의 수강 상태가 취소 된다.
- 특정 수강생의 결제 내역이 환불 된다.

### 인수 테스트 특징
- Black Box 테스트
  - 내부 구조나 작동과 연관이 없는 테스트

### UI 테스트 대신 API 인수 테스트
- 개발자 입장에선 공수가 너무 많이 든다
- API 레벨에서 인수 테스트를 작성

> UI 는 변동이 많기 때문에 깨지기 쉬운 테스트이다.

### 테스트 도구
- 테스트 환경
  - @SpringBootTest
- 테스트 클라이언트

### @SpringBootTest
- SpringExtension
  - 스프링 테스트 컨텍스트를 생성
- SpringBootTestContextBootstrapper
  - 스프링 부트 자동 설정을 지원
- webEnvironment 속성을 활용

### MockMvc, WebTestClient, RestAssured
- MockMvc
  - @SpringBootTest의 webEnvironment.MOCK과 함께 사용 가능하며 mocking 된 web environment 환경에서 테스트
  - 실제 환경보다 테스트가 빠르다.
  - 실제 환경보다는 다를 수 있다.
- WebTestClient
  - @SpringBootTest의 webEnvironment.RANDOM_PORT 나 DEFINED_PORT와 함께 사용, Netty를 기본으로 사용
- RestAssured
  - 실제 웹 환경(Tomcat) 을 사용하여 테스트

> 큰 차이는 없다..
> 각 서비스에 맞는 적합한 방법을 택하는게 좋다.

### repository 활용한 데이터 초기화
- 손십게 데이터 초기화가 가능
- 구현이 달라지면 테스트 영향을 받는다
- 유효성 검사 로직이 없다
- 깨지기 쉬운 테스트가 될 가능성이 높다

> 내부 구현에 의존이 높아진다.\
> 초기화될 값이 유효한지 검증하기 어렵다.\
> 실제 사용되는 데이터유형과 테스트에 사용되는 데이터유형이 따로 놀게 될 수도 있다.\
> 데이터의 유효성을 검증하게 된다면 이또한 내부 구현에 대한 의존하게 된다.

### @DirtiesContext
- 스프링 테스트 환경에서 **캐싱** 된 Context 를 사용하지 않게 설정한다.
  - 다른 테스트에 영향을 주는 원인
- 컨텍스트 구축 비용이 많이 든다.

> 매번 새로운 컨텍스트를 생성해서 사용하지만, 시간이 많이 걸린다.

## 중복 처리와 가독성 개선
- 가독성이 좋지 않으면 방치될 가능성이 높다.
- 반복되는 코드는 **메서드로 분리**
- 재사용을 위한 별도 클래스 분리
- 한글 메서드 네이밍
  - 의도를 잘 드러내고, 가독성을 높힐 수 있다.
- 중복된 내용을 검증
- 외부 API 호출
  - 깃헙 API -> 테스트 환경을 구축할 수 있기 때문에, 테스트 계정으로 실제 요청 처리를 한다.
  - 결제 API -> 실제가 아닌 Fake 서비스에 요청하도록 구성한다.

## 작성 팁
- 간단한 성공 케이스를 우선 작성하라
- 인수 테스트 클래스
  - 같은 테스트 픽스처를 공유하는 테스트를 클래스 단위로 묶음
- BDD 에서는 Outside In 방식의 TDD를 말한다.
    - 명세를 먼저하고, step by step 으로 진행..


